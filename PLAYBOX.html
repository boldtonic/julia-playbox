<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Julia's Playbox</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --pink: #FF6B9D;
            --purple: #9B59B6;
            --blue: #3498DB;
            --green: #2ECC71;
            --yellow: #F1C40F;
            --orange: #E67E22;
            --red: #E74C3C;
            --cyan: #1ABC9C;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            --radius: 24px;
        }

        body {
            font-family: 'Comic Sans MS', 'Chalkboard', 'Comic Neue', cursive, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .bubbles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 0;
        }

        .bubble {
            position: absolute;
            bottom: -100px;
            border-radius: 50%;
            opacity: 0.6;
            animation: float-up linear infinite;
        }

        @keyframes float-up {
            0% { transform: translateY(0) rotate(0deg); opacity: 0.6; }
            100% { transform: translateY(-110vh) rotate(720deg); opacity: 0; }
        }

        /* HEADER */
        .top-header {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* MAIN TABS */
        .main-tabs {
            display: flex;
            gap: 8px;
            margin-left: 20px;
        }

        .main-tab {
            padding: 10px 24px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .main-tab:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .main-tab.active {
            background: white;
            color: var(--purple);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .main-tab .tab-icon {
            font-size: 1.3rem;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* PAINT TAB STYLES */
        .paint-container {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .paint-toolbar {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 15px 20px;
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            position: relative;
            z-index: 2;
        }

        .paint-colors {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .color-btn {
            width: 44px;
            height: 44px;
            border: 3px solid transparent;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
        }

        @media (max-width: 600px) {
            .paint-container { padding: 10px; }
            .paint-toolbar { padding: 12px; gap: 10px; border-radius: 16px; }
            .color-btn { width: 36px; height: 36px; }
            .brush-size-control { padding: 6px 10px; }
            .brush-size-control label { display: none; }
            .brush-slider { width: 80px; }
            .brush-preview { width: 40px; height: 40px; }
            .paint-btn { padding: 10px 14px; font-size: 0.9rem; }
            .paint-btn span:last-child { display: none; }
            .canvas-wrapper { padding: 10px; border-radius: 16px; }
            #paintCanvas { min-height: 200px; max-height: 400px; height: calc(100vh - 320px); }
        }

        .color-btn:hover {
            transform: scale(1.15);
        }

        .color-btn.active {
            border-color: white;
            box-shadow: 0 0 0 3px var(--purple), 0 4px 12px rgba(0, 0, 0, 0.3);
            transform: scale(1.1);
        }

        .brush-size-control {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.05);
            padding: 8px 15px;
            border-radius: 25px;
        }

        .brush-size-control label {
            font-weight: bold;
            color: #666;
            font-size: 0.9rem;
        }

        .brush-slider {
            width: 120px;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(90deg, var(--purple), var(--pink));
            border-radius: 4px;
        }

        .brush-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .brush-preview {
            width: 50px;
            height: 50px;
            background: #f0f0f0;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .brush-dot {
            border-radius: 50%;
            background: #333;
            transition: all 0.15s ease;
        }

        .paint-actions {
            display: flex;
            gap: 10px;
        }

        .paint-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 16px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 0 rgba(0, 0, 0, 0.15);
        }

        .paint-btn:active {
            transform: translateY(3px);
            box-shadow: 0 1px 0 rgba(0, 0, 0, 0.15);
        }

        .paint-btn.clear { background: var(--red); color: white; }
        .paint-btn.undo { background: var(--orange); color: white; }
        .paint-btn.save { background: var(--green); color: white; }
        .paint-btn.eraser { background: #f0f0f0; color: #666; }
        .paint-btn.eraser.active { background: var(--purple); color: white; }

        .canvas-wrapper {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 15px;
            box-shadow: var(--shadow);
            touch-action: none;
            position: relative;
            z-index: 2;
        }

        #paintCanvas {
            display: block;
            width: 100%;
            height: calc(100vh - 380px);
            min-height: 250px;
            max-height: 500px;
            position: relative;
            z-index: 3;
            background: white;
            border-radius: 16px;
            cursor: crosshair;
            touch-action: none;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            flex-wrap: wrap;
        }

        .logo-section h1 {
            font-size: clamp(1.2rem, 4vw, 2rem);
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            animation: bounce 2s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* MOBILE RESPONSIVE - Global */
        @media (max-width: 768px) {
            .top-header { padding: 10px 15px; }
            .header-content {
                gap: 10px;
                justify-content: center;
            }
            .logo-section {
                width: 100%;
                text-align: center;
                order: 1;
            }
            .main-tabs {
                margin-left: 0;
                order: 2;
                justify-content: center;
                width: 100%;
            }
            .main-tab {
                padding: 8px 16px;
                font-size: 0.9rem;
            }
            .main-tab span:not(.tab-icon) { display: none; }
            .main-tab .tab-icon { font-size: 1.4rem; }
            .header-controls {
                order: 3;
                width: 100%;
                justify-content: center;
            }
            .volume-control { display: none; }
            .settings-toggle span:last-child { display: none; }
        }

        @media (max-width: 480px) {
            .logo-section h1 { font-size: 1.1rem; }
            .main-tab { padding: 10px 14px; }
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.15);
            padding: 8px 15px;
            border-radius: 25px;
        }

        .volume-control span { font-size: 1.2rem; }

        .volume-slider {
            width: 120px;
            height: 12px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 6px;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 32px;
            height: 32px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .settings-toggle {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            padding: 10px 15px;
            border-radius: 25px;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .settings-toggle:hover { background: rgba(255, 255, 255, 0.25); }
        .settings-toggle.active { background: var(--purple); }

        /* VISUALIZER */
        .visualizer-section {
            background: linear-gradient(180deg, rgba(0,0,0,0.3) 0%, transparent 100%);
            padding: 20px 20px 20px;
            margin-top: 10px;
            position: relative;
            z-index: 1;
        }

        .visualizer-container { max-width: 1400px; margin: 0 auto; }

        .visualizer-canvas {
            width: 100%;
            height: 100px;
            border-radius: 16px;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        @media (max-width: 600px) {
            .visualizer-section { padding: 15px 15px 15px; margin-top: 5px; }
            .visualizer-canvas { height: 60px; border-radius: 12px; }
        }

        /* SETTINGS PANEL */
        .settings-panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }

        .settings-panel.show {
            max-height: 200px;
            padding: 15px 20px;
        }

        .settings-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .setting-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 18px;
            border-radius: 25px;
            color: white;
        }

        .setting-item span { font-size: 0.9rem; font-weight: bold; }

        .toggle {
            width: 44px;
            height: 24px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 24px;
            cursor: pointer;
            position: relative;
            transition: background 0.3s;
        }

        .toggle.on { background: var(--green); }

        .toggle::after {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: transform 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle.on::after { transform: translateX(20px); }

        /* MAIN CONTENT */
        .main-content {
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .bento-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            max-width: 1400px;
            margin: 0 auto;
        }

        @media (min-width: 768px) {
            .bento-grid { grid-template-columns: repeat(2, 1fr); gap: 20px; }
        }

        @media (min-width: 1024px) {
            .bento-grid { grid-template-columns: repeat(3, 1fr); }
        }

        .bento-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .bento-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
        }

        .bento-card.large { grid-column: span 2; }
        .bento-card.full { grid-column: 1 / -1; }

        @media (min-width: 1024px) {
            .bento-card.large { grid-column: span 2; }
            .bento-card.full { grid-column: 1 / -1; }
        }

        @media (max-width: 767px) {
            .main-content { padding: 15px 10px; }
            .bento-grid { grid-template-columns: 1fr; gap: 12px; }
            .bento-card { padding: 15px; border-radius: 18px; }
            .bento-card.large, .bento-card.full { grid-column: 1; }
            .bento-card:hover { transform: none; }
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-icon { font-size: 1.8rem; }
        .card-name { font-size: 1.1rem; font-weight: bold; color: #333; }

        @media (max-width: 480px) {
            .card-icon { font-size: 1.5rem; }
            .card-name { font-size: 1rem; }
        }

        .more-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 50%;
            background: #f0f0f0;
            color: #666;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .more-btn:hover { background: #e0e0e0; transform: scale(1.1); }
        .more-btn.active { background: var(--purple); color: white; transform: rotate(45deg); }

        .card-content { flex: 1; display: flex; flex-direction: column; }
        .card-actions { display: flex; flex-wrap: wrap; gap: 8px; }

        .card-more {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px dashed #eee;
            animation: slideDown 0.3s ease;
        }

        .card-more.show { display: block; }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .action-btn {
            padding: 12px 18px;
            border: none;
            border-radius: 16px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 0 rgba(0, 0, 0, 0.15);
        }

        .action-btn:active { transform: translateY(3px); box-shadow: 0 1px 0 rgba(0, 0, 0, 0.15); }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .action-btn.primary { background: var(--purple); color: white; }
        .action-btn.green { background: var(--green); color: white; }
        .action-btn.red { background: var(--red); color: white; }
        .action-btn.blue { background: var(--blue); color: white; }
        .action-btn.orange { background: var(--orange); color: white; }
        .action-btn.pink { background: var(--pink); color: white; }
        .action-btn.cyan { background: var(--cyan); color: white; }

        /* INSTRUMENTS */
        .instrument-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
            padding: 10px;
            background: rgba(0, 0, 0, 0.03);
            border-radius: 16px;
        }

        .instrument-chip {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            background: white;
            color: #666;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .instrument-chip:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }

        .instrument-chip.active {
            background: linear-gradient(135deg, var(--pink), var(--purple));
            color: white;
            box-shadow: 0 4px 20px rgba(255, 107, 157, 0.5);
            transform: scale(1.05);
        }

        .instrument-chip .chip-icon {
            font-size: 1.3rem;
        }

        @media (max-width: 600px) {
            .instrument-selector {
                gap: 6px;
                padding: 8px;
            }
            .instrument-chip {
                padding: 8px 12px;
                font-size: 0.85rem;
                gap: 5px;
            }
            .instrument-chip .chip-icon { font-size: 1.1rem; }
            /* Hide text on very small screens, show only icons */
        }

        @media (max-width: 400px) {
            .instrument-chip {
                padding: 10px;
                font-size: 0;
            }
            .instrument-chip .chip-icon { font-size: 1.3rem; }
        }

        .piano-container { overflow-x: auto; padding: 15px 0; -webkit-overflow-scrolling: touch; }
        .piano { display: flex; justify-content: center; gap: 3px; min-width: fit-content; }

        .piano-key {
            width: 50px;
            height: 140px;
            border: none;
            border-radius: 0 0 8px 8px;
            cursor: pointer;
            transition: all 0.1s ease;
            position: relative;
            font-size: 0.7rem;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 8px;
            color: #999;
        }

        .piano-key.white { background: linear-gradient(180deg, #fff 0%, #e8e8e8 100%); box-shadow: 0 6px 0 #bbb; }
        .piano-key.black { background: linear-gradient(180deg, #333 0%, #111 100%); width: 35px; height: 90px; margin: 0 -17px; z-index: 2; box-shadow: 0 6px 0 #000; color: #666; }
        .piano-key:active, .piano-key.active { transform: translateY(4px); box-shadow: none; }

        /* Mobile-friendly sizes */
        @media (max-width: 480px) {
            .piano-key { width: 36px; height: 100px; font-size: 0.6rem; }
            .piano-key.black { width: 26px; height: 65px; margin: 0 -13px; }
            .piano-container { padding: 10px 0; }
        }

        /* Tablet-friendly sizes */
        @media (min-width: 600px) {
            .piano-key { width: 60px; height: 160px; }
            .piano-key.black { width: 40px; height: 100px; margin: 0 -20px; }
        }

        @media (min-width: 900px) {
            .piano-key { width: 70px; height: 180px; }
            .piano-key.black { width: 45px; height: 110px; margin: 0 -22px; }
        }

        /* ==========================================
           REALISTIC INSTRUMENT STYLES
           ========================================== */

        /* DRUMS - Realistic drum heads with rim */
        .drum-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #2c2c2c 0%, #1a1a1a 100%);
            border-radius: 20px;
        }

        @media (min-width: 768px) {
            .drum-grid { grid-template-columns: repeat(4, 1fr); max-width: 450px; }
        }

        .drum-pad {
            aspect-ratio: 1;
            border: 6px solid #444;
            border-radius: 50%;
            font-size: 1.8rem;
            cursor: pointer;
            transition: all 0.05s ease;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.1) 0%, transparent 50%);
            box-shadow:
                inset 0 0 30px rgba(0,0,0,0.5),
                0 4px 8px rgba(0,0,0,0.5),
                0 0 0 3px #222;
        }

        .drum-pad .pad-label {
            font-size: 0.6rem;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.8);
            text-transform: uppercase;
        }

        .drum-pad:active, .drum-pad.active {
            transform: scale(0.95);
            box-shadow: inset 0 0 40px rgba(0,0,0,0.7), 0 2px 4px rgba(0,0,0,0.5);
        }

        /* XYLOPHONE - Wooden/metal bars with mallets */
        .xylo-grid {
            display: flex;
            gap: 6px;
            justify-content: center;
            align-items: flex-end;
            padding: 20px;
            background: linear-gradient(180deg, #8B4513 0%, #5D3A1A 100%);
            border-radius: 15px;
            box-shadow: inset 0 -5px 15px rgba(0,0,0,0.3);
        }

        .xylo-btn {
            width: 50px;
            min-height: 90px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.08s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            padding-bottom: 8px;
            position: relative;
            box-shadow:
                0 4px 0 rgba(0,0,0,0.4),
                inset 0 2px 10px rgba(255,255,255,0.3),
                inset 0 -2px 10px rgba(0,0,0,0.2);
        }

        .xylo-btn::after {
            content: '';
            position: absolute;
            bottom: -15px;
            width: 8px;
            height: 15px;
            background: #654321;
            border-radius: 0 0 3px 3px;
        }

        .xylo-btn .note-label {
            font-size: 0.7rem;
            font-weight: bold;
            color: rgba(0, 0, 0, 0.7);
            text-shadow: 0 1px 0 rgba(255,255,255,0.3);
        }

        .xylo-btn:active {
            transform: translateY(3px) rotateX(10deg);
            box-shadow: 0 1px 0 rgba(0,0,0,0.4);
        }

        /* GUITAR - Horizontal strings on fretboard */
        .guitar-grid {
            display: flex;
            flex-direction: column;
            gap: 0;
            padding: 15px 30px;
            background: linear-gradient(90deg, #2C1810 0%, #4A3728 50%, #2C1810 100%);
            border-radius: 10px;
            position: relative;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }

        .guitar-grid::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #888;
            transform: translateX(-50%);
        }

        .string-btn {
            width: 100%;
            height: 40px;
            border: none;
            background: transparent;
            cursor: pointer;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding-left: 10px;
        }

        .string-btn::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            height: 3px;
            background: linear-gradient(90deg, #DAA520, #FFD700, #DAA520);
            box-shadow: 0 1px 2px rgba(0,0,0,0.5);
            transform: translateY(-50%);
            transition: all 0.1s;
        }

        .string-btn:active::before {
            height: 5px;
            filter: brightness(1.3);
            animation: stringVibrate 0.1s ease-in-out;
        }

        @keyframes stringVibrate {
            0%, 100% { transform: translateY(-50%); }
            25% { transform: translateY(-55%); }
            75% { transform: translateY(-45%); }
        }

        .string-btn .note-label {
            font-size: 0.7rem;
            color: #FFD700;
            z-index: 1;
            background: #2C1810;
            padding: 2px 6px;
            border-radius: 3px;
        }

        /* BELLS - Actual bell shapes */
        .bells-grid {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
            padding: 20px;
        }

        .bell-btn {
            width: 65px;
            height: 75px;
            border: none;
            background: linear-gradient(180deg, #FFD700 0%, #B8860B 50%, #8B6914 100%);
            cursor: pointer;
            position: relative;
            clip-path: polygon(20% 0%, 80% 0%, 100% 100%, 0% 100%);
            box-shadow: 2px 4px 8px rgba(0,0,0,0.3);
            transition: all 0.1s;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 8px;
        }

        .bell-btn::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 12px;
            height: 12px;
            background: #8B6914;
            border-radius: 50%;
        }

        .bell-btn::after {
            content: '';
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 8px;
            background: #654321;
            border-radius: 50%;
        }

        .bell-btn:active {
            transform: rotate(-10deg);
        }

        .bell-btn .note-label {
            font-size: 0.6rem;
            color: #4A3000;
            font-weight: bold;
            z-index: 1;
        }

        /* BASS - Thick horizontal strings */
        .bass-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 20px 40px;
            background: linear-gradient(90deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 15px;
            border: 3px solid #333;
        }

        .bass-btn {
            width: 100%;
            height: 40px;
            border: none;
            background: transparent;
            cursor: pointer;
            position: relative;
            display: flex;
            align-items: center;
        }

        .bass-btn::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            background: linear-gradient(90deg, #8B8B8B, #C0C0C0, #8B8B8B);
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            transform: translateY(-50%);
            transition: all 0.1s;
            border-radius: 3px;
        }

        .bass-btn:nth-child(1)::before { height: 8px; }
        .bass-btn:nth-child(2)::before { height: 7px; }
        .bass-btn:nth-child(3)::before { height: 6px; }
        .bass-btn:nth-child(4)::before { height: 5px; }
        .bass-btn:nth-child(5)::before { height: 4px; }
        .bass-btn:nth-child(6)::before { height: 3px; }

        .bass-btn:active::before {
            filter: brightness(1.4);
            animation: stringVibrate 0.15s ease-in-out;
        }

        .bass-btn .note-label {
            font-size: 0.7rem;
            color: #00ff88;
            z-index: 1;
            background: #1a1a2e;
            padding: 2px 8px;
            border-radius: 3px;
            margin-left: 10px;
        }

        /* SYNTH - Modular synth knobs */
        .synth-grid {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            padding: 25px;
            background: linear-gradient(180deg, #2d2d2d 0%, #1a1a1a 100%);
            border-radius: 15px;
            border: 2px solid #444;
        }

        .synth-btn {
            width: 70px;
            height: 80px;
            border: none;
            background: #333;
            border-radius: 12px;
            cursor: pointer;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.4);
        }

        .synth-btn::before {
            content: '';
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, #666 0%, #333 100%);
            border-radius: 50%;
            border: 3px solid #222;
            box-shadow: inset 0 2px 5px rgba(255,255,255,0.1);
        }

        .synth-btn::after {
            content: '';
            position: absolute;
            top: 18px;
            width: 3px;
            height: 12px;
            background: #00ffff;
            border-radius: 2px;
            box-shadow: 0 0 8px #00ffff;
        }

        .synth-btn:active::after {
            background: #ff00ff;
            box-shadow: 0 0 15px #ff00ff;
        }

        .synth-btn .note-label {
            font-size: 0.65rem;
            color: #00ffff;
        }

        /* HARP - Elegant vertical strings on golden frame */
        .harp-grid {
            display: flex;
            gap: 0;
            justify-content: center;
            align-items: flex-end;
            padding: 20px 30px;
            background: linear-gradient(180deg, transparent 0%, rgba(218,165,32,0.1) 100%);
            border-left: 15px solid;
            border-image: linear-gradient(180deg, #DAA520, #B8860B) 1;
            border-radius: 0 30px 0 0;
            position: relative;
        }

        .harp-grid::before {
            content: '';
            position: absolute;
            top: 0;
            left: -15px;
            right: 50%;
            height: 20px;
            background: linear-gradient(90deg, #DAA520, transparent);
            border-radius: 0 20px 0 0;
        }

        .harp-btn {
            width: 25px;
            min-height: 100px;
            border: none;
            background: transparent;
            cursor: pointer;
            transition: all 0.05s ease;
            position: relative;
        }

        .harp-btn::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 3px;
            transform: translateX(-50%);
            background: linear-gradient(180deg, #FFD700 0%, #DAA520 50%, #B8860B 100%);
            box-shadow: 0 0 3px rgba(255,215,0,0.5);
            border-radius: 1px;
            transition: all 0.05s ease;
        }

        .harp-btn:hover::before {
            background: #FFF8DC;
            box-shadow: 0 0 10px rgba(255,215,0,0.8);
        }

        .harp-btn:active::before {
            width: 6px;
            background: #FFFACD;
            box-shadow: 0 0 15px rgba(255,215,0,1);
        }

        /* KALIMBA - Metal tines on wooden body */
        .kalimba-grid {
            display: flex;
            gap: 6px;
            justify-content: center;
            align-items: flex-end;
            padding: 30px 25px 20px;
            background: linear-gradient(180deg, #DEB887 0%, #8B4513 100%);
            border-radius: 60px 60px 30px 30px;
            box-shadow: inset 0 5px 15px rgba(0,0,0,0.2), 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }

        .kalimba-grid::before {
            content: '';
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 40px;
            background: #2C1810;
            border-radius: 50%;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
        }

        .kalimba-btn {
            width: 32px;
            min-height: 80px;
            border: none;
            background: linear-gradient(180deg, #E8E8E8 0%, #C0C0C0 50%, #A0A0A0 100%);
            cursor: pointer;
            transition: all 0.05s ease;
            border-radius: 5px 5px 20px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            position: relative;
        }

        .kalimba-btn::after {
            content: '';
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 10px;
            height: 10px;
            background: #666;
            border-radius: 50%;
        }

        .kalimba-btn:active {
            transform: translateY(3px) rotateX(15deg);
            filter: brightness(1.2);
        }

        /* STEEL DRUMS - Caribbean pan sections */
        .steeldrums-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            max-width: 360px;
            margin: 0 auto;
            padding: 25px;
            background: radial-gradient(circle, #444 0%, #222 100%);
            border-radius: 50%;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5), inset 0 -5px 20px rgba(0,0,0,0.5);
        }

        .steeldrum-btn {
            width: 75px;
            height: 65px;
            border: 2px solid #333;
            border-radius: 30% 70% 70% 30% / 60% 40% 60% 40%;
            font-size: 0;
            cursor: pointer;
            transition: all 0.05s ease;
            box-shadow: inset 0 -5px 15px rgba(0,0,0,0.4), inset 0 5px 10px rgba(255,255,255,0.1);
        }

        .steeldrum-btn:active {
            transform: scale(0.95);
            box-shadow: inset 0 0px 20px rgba(0,0,0,0.6);
        }

        /* ORGAN - Church pipe organ */
        .organ-grid {
            display: flex;
            gap: 6px;
            justify-content: center;
            align-items: flex-end;
            padding: 35px 25px 15px;
            background: linear-gradient(180deg, #4A3728 0%, #2C1810 100%);
            border-radius: 10px;
            position: relative;
        }

        .organ-grid::before {
            content: '♱';
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.4rem;
            color: #DAA520;
        }

        .organ-btn {
            width: 45px;
            min-height: 80px;
            border: none;
            background: linear-gradient(90deg, #C0C0C0 0%, #E8E8E8 50%, #C0C0C0 100%);
            cursor: pointer;
            transition: all 0.08s ease;
            border-radius: 50% 50% 0 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4), inset 0 -10px 20px rgba(0,0,0,0.1);
            position: relative;
        }

        .organ-btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 4px;
            background: #8B4513;
        }

        .organ-btn:active {
            transform: translateY(3px);
            filter: brightness(0.9);
        }

        /* MARIMBA - Wooden bars with resonators */
        .marimba-grid {
            display: flex;
            gap: 8px;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            background: linear-gradient(180deg, #2C2C2C 0%, #1a1a1a 100%);
            border-radius: 10px;
        }

        .marimba-btn {
            width: 55px;
            min-height: 70px;
            border: none;
            background: linear-gradient(180deg, #DEB887 0%, #D2691E 30%, #8B4513 100%);
            cursor: pointer;
            transition: all 0.08s ease;
            border-radius: 5px;
            box-shadow: 0 4px 0 #5D3A1A, 0 8px 15px rgba(0,0,0,0.4);
            position: relative;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 8px;
        }

        .marimba-btn::after {
            content: '';
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            width: 25px;
            height: 20px;
            background: linear-gradient(180deg, #B8860B 0%, #8B6914 100%);
            border-radius: 0 0 50% 50%;
            box-shadow: inset 0 -5px 10px rgba(0,0,0,0.3);
        }

        .marimba-btn:active {
            transform: translateY(3px);
            box-shadow: 0 1px 0 #5D3A1A;
        }

        /* FLUTE - Silver tube with keys */
        .flute-grid {
            display: flex;
            gap: 5px;
            justify-content: center;
            align-items: center;
            padding: 25px;
            background: linear-gradient(90deg,
                transparent 0%,
                rgba(192,192,192,0.1) 10%,
                rgba(192,192,192,0.2) 50%,
                rgba(192,192,192,0.1) 90%,
                transparent 100%);
            position: relative;
        }

        .flute-grid::before {
            content: '';
            position: absolute;
            left: 10%;
            right: 10%;
            height: 50px;
            background: linear-gradient(180deg, #E8E8E8 0%, #C0C0C0 50%, #A0A0A0 100%);
            border-radius: 25px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3), inset 0 2px 5px rgba(255,255,255,0.5);
            z-index: 0;
        }

        .flute-btn {
            width: 50px;
            height: 50px;
            border: 3px solid #888;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #E8E8E8, #A0A0A0);
            cursor: pointer;
            transition: all 0.1s ease;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.3), 0 2px 4px rgba(0,0,0,0.2);
            z-index: 1;
            font-size: 0;
            position: relative;
        }

        .flute-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 22px;
            height: 22px;
            background: #333;
            border-radius: 50%;
        }

        .flute-btn:active {
            transform: scale(0.9);
            background: radial-gradient(circle at 30% 30%, #C0C0C0, #808080);
        }

        /* MUSIC BOX - Delicate cylinder with pins */
        .chimes-grid {
            display: flex;
            gap: 6px;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(180deg, #FFF8DC 0%, #FFE4B5 100%);
            border: 8px solid #DEB887;
            border-radius: 15px;
            box-shadow: inset 0 0 20px rgba(139,69,19,0.2);
        }

        .chimes-btn {
            width: 28px;
            height: 70px;
            border: none;
            background: linear-gradient(90deg, #FFD700 0%, #FFF8DC 50%, #FFD700 100%);
            cursor: pointer;
            transition: all 0.08s ease;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chimes-btn:active {
            transform: translateY(-5px);
            box-shadow: 0 7px 10px rgba(0,0,0,0.2);
        }

        .chimes-btn::after {
            content: '✦';
            font-size: 0.7rem;
            color: #DAA520;
        }

        /* TRUMPET - Brass valves */
        .trumpet-grid {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: flex-end;
            padding: 25px 30px;
            background: linear-gradient(90deg, #B8860B 0%, #DAA520 20%, #FFD700 50%, #DAA520 80%, #B8860B 100%);
            border-radius: 0 100px 100px 0;
            box-shadow: inset 0 5px 15px rgba(255,255,255,0.3), inset 0 -5px 15px rgba(0,0,0,0.3), 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }

        .trumpet-grid::before {
            content: '';
            position: absolute;
            left: -30px;
            top: 50%;
            transform: translateY(-50%);
            width: 50px;
            height: 25px;
            background: linear-gradient(180deg, #DAA520, #B8860B);
            border-radius: 10px 0 0 10px;
        }

        .trumpet-btn {
            width: 55px;
            height: 70px;
            border: none;
            background: linear-gradient(180deg, #E8E8E8 0%, #C0C0C0 30%, #A0A0A0 100%);
            cursor: pointer;
            transition: all 0.05s ease;
            border-radius: 10px;
            box-shadow: 0 4px 0 #666, inset 0 2px 5px rgba(255,255,255,0.5);
            position: relative;
        }

        .trumpet-btn::before {
            content: '';
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 32px;
            height: 32px;
            background: radial-gradient(circle, #888 0%, #666 100%);
            border-radius: 50%;
            border: 2px solid #555;
        }

        .trumpet-btn:active {
            transform: translateY(3px);
            box-shadow: 0 1px 0 #666;
        }

        /* Mobile responsive for realistic instruments */
        @media (max-width: 600px) {
            .drum-grid { max-width: 320px; gap: 10px; padding: 15px; }
            .drum-pad { min-height: 60px; font-size: 1.4rem; border-width: 4px; }
            .xylo-grid { padding: 15px 10px; gap: 4px; }
            .xylo-btn { width: 40px; min-height: 70px; }
            .guitar-grid { padding: 10px 20px; }
            .string-btn { height: 32px; }
            .bells-grid { gap: 8px; }
            .bell-btn { width: 55px; height: 65px; }
            .bass-grid { padding: 15px 25px; }
            .bass-btn { height: 32px; }
            .synth-grid { padding: 15px; gap: 10px; }
            .synth-btn { width: 60px; height: 70px; }
            .harp-grid { padding: 15px 20px; }
            .harp-btn { width: 20px; min-height: 80px; }
            .kalimba-grid { padding: 20px 15px 12px; gap: 3px; }
            .kalimba-btn { width: 26px; min-height: 65px; }
            .steeldrums-grid { max-width: 280px; padding: 15px; }
            .steeldrum-btn { width: 60px; height: 50px; }
            .organ-grid { padding: 25px 15px 12px; gap: 3px; }
            .organ-btn { width: 35px; min-height: 65px; }
            .marimba-grid { padding: 15px; gap: 5px; }
            .marimba-btn { width: 45px; min-height: 55px; }
            .flute-grid { padding: 15px; }
            .flute-btn { width: 42px; height: 42px; }
            .chimes-grid { padding: 15px; border-width: 5px; gap: 5px; }
            .chimes-btn { width: 24px; height: 55px; }
            .trumpet-grid { padding: 20px; gap: 10px; }
            .trumpet-btn { width: 48px; height: 60px; }
        }

        /* SOUND GRID */
        .sound-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            max-height: 280px;
            overflow-y: auto;
            padding: 5px;
        }

        @media (max-width: 600px) {
            .sound-grid { grid-template-columns: repeat(4, 1fr); }
        }

        .sound-btn {
            aspect-ratio: 1;
            border: none;
            border-radius: 16px;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 0 rgba(0, 0, 0, 0.2);
            position: relative;
            min-height: 60px;
        }

        @media (min-width: 600px) {
            .sound-btn { font-size: 2.5rem; min-height: 70px; }
        }

        .sound-btn:hover { transform: translateY(-2px); }
        .sound-btn:active, .sound-btn.active { transform: translateY(3px); box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2); }
        .sound-btn.playing { animation: pulse 0.3s ease; }
        .sound-btn.looping {
            box-shadow: 0 0 0 3px var(--green), 0 4px 0 rgba(0, 0, 0, 0.2);
            animation: loopPulse 1s infinite;
        }

        @keyframes pulse { 50% { transform: scale(1.15); } }
        @keyframes loopPulse {
            0%, 100% { box-shadow: 0 0 0 3px var(--green), 0 4px 0 rgba(0, 0, 0, 0.2); }
            50% { box-shadow: 0 0 0 5px var(--green), 0 4px 0 rgba(0, 0, 0, 0.2); }
        }

        /* SOUND CONTROLS */
        .sound-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .sound-control-btn {
            padding: 8px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            cursor: pointer;
            background: white;
            color: #666;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .sound-control-btn:hover { border-color: var(--purple); color: var(--purple); }
        .sound-control-btn.active { background: var(--green); border-color: var(--green); color: white; }

        /* SOUND MIXER */
        .sound-mixer {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .mixer-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .mixer-title {
            font-weight: bold;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mixer-tracks {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .mixer-track {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            padding: 8px 12px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .mixer-track-emoji {
            font-size: 1.5rem;
            width: 35px;
            text-align: center;
        }

        .mixer-track-name {
            flex: 1;
            font-size: 0.85rem;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mixer-track-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mixer-volume {
            width: 100px;
            height: 12px;
            -webkit-appearance: none;
            background: #ddd;
            border-radius: 6px;
            outline: none;
        }

        .mixer-volume::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 28px;
            height: 28px;
            background: var(--purple);
            border-radius: 50%;
            cursor: pointer;
        }

        .mixer-btn {
            width: 44px;
            height: 44px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mixer-btn.play { background: var(--green); color: white; }
        .mixer-btn.stop { background: var(--red); color: white; }
        .mixer-btn.remove { background: #ddd; color: #666; }

        .mixer-empty {
            text-align: center;
            padding: 20px;
            color: #999;
            font-size: 0.9rem;
        }

        /* LOOP SETTINGS MODAL */
        .loop-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .loop-modal.show { display: flex; }

        .loop-modal-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 350px;
            width: 100%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .loop-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .loop-modal-title {
            font-size: 1.2rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .loop-modal-close {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            background: #f0f0f0;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .loop-setting {
            margin-bottom: 18px;
        }

        .loop-setting-label {
            display: block;
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }

        .loop-setting-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .loop-option {
            padding: 8px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: bold;
            transition: all 0.2s;
        }

        .loop-option:hover { border-color: var(--purple); }
        .loop-option.selected { background: var(--purple); color: white; border-color: var(--purple); }

        .loop-slider-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .loop-slider {
            flex: 1;
            height: 8px;
            -webkit-appearance: none;
            background: linear-gradient(90deg, var(--blue), var(--purple));
            border-radius: 4px;
            outline: none;
        }

        .loop-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: white;
            border: 3px solid var(--purple);
            border-radius: 50%;
            cursor: pointer;
        }

        .loop-slider-value {
            min-width: 50px;
            text-align: center;
            font-weight: bold;
            color: var(--purple);
        }

        .loop-modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .loop-modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
        }

        .loop-modal-btn.primary { background: var(--green); color: white; }
        .loop-modal-btn.secondary { background: #f0f0f0; color: #333; }

        /* LOADING INDICATOR */
        .sound-btn.loading {
            position: relative;
            pointer-events: none;
        }

        .sound-btn.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .sound-btn.playing {
            animation: pulse 0.5s ease;
            box-shadow: 0 0 0 4px rgba(46, 204, 113, 0.4), 0 6px 0 rgba(0,0,0,0.2);
        }

        /* CATEGORY TABS */
        .category-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .category-tab {
            padding: 8px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: bold;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .category-tab:hover { border-color: var(--purple); }
        .category-tab.active { background: var(--purple); color: white; border-color: var(--purple); }

        /* SOUND CATEGORIES */
        .sound-category {
            margin-bottom: 15px;
            border-radius: 16px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.03);
        }

        .category-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15));
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .category-header:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.25), rgba(118, 75, 162, 0.25));
        }

        .category-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            font-size: 1rem;
            color: #333;
        }

        .category-icon {
            font-size: 1.3rem;
        }

        .category-count {
            background: rgba(0, 0, 0, 0.1);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            color: #666;
        }

        .category-toggle {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .category-toggle.open {
            transform: rotate(180deg);
        }

        .category-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, padding 0.3s ease;
            padding: 0 10px;
        }

        .category-content.open {
            max-height: 500px;
            padding: 12px 10px;
        }

        .category-sounds {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
        }

        @media (max-width: 600px) {
            .category-sounds { grid-template-columns: repeat(4, 1fr); }
        }

        @media (min-width: 900px) {
            .category-sounds { grid-template-columns: repeat(6, 1fr); }
        }

        /* TRACKS */
        .track-grid { display: flex; flex-direction: column; gap: 8px; }

        .track-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: #f8f9fa;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .track-row.playing { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }

        .track-play-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            font-size: 1.1rem;
            cursor: pointer;
            background: var(--green);
            color: white;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .track-play-btn:hover { transform: scale(1.1); }
        .track-play-btn.stop { background: var(--red); }

        .track-name { flex: 1; font-weight: bold; font-size: 0.95rem; }

        /* MIC */
        .mic-status-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .mic-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #ccc;
            flex-shrink: 0;
        }

        .mic-dot.ready { background: var(--green); }
        .mic-dot.recording { background: var(--red); animation: mic-pulse 1s infinite; }
        .mic-dot.monitoring { background: var(--blue); animation: mic-pulse 1.5s infinite; }

        @keyframes mic-pulse { 50% { opacity: 0.5; transform: scale(1.2); } }

        .mic-level {
            flex: 1;
            height: 8px;
            background: #ddd;
            border-radius: 4px;
            overflow: hidden;
        }

        .mic-level-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--green), var(--yellow), var(--red));
            transition: width 0.05s;
        }

        .voice-effects { margin-top: 12px; }

        .effect-label {
            font-size: 0.85rem;
            font-weight: bold;
            color: #666;
            margin-bottom: 8px;
            display: block;
        }

        .effect-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }

        .effect-chip {
            padding: 8px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            cursor: pointer;
            background: white;
            color: #666;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .effect-chip:hover { border-color: var(--purple); color: var(--purple); }
        .effect-chip.active { background: var(--purple); border-color: var(--purple); color: white; }

        .effect-slider-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .effect-slider-label {
            font-size: 0.85rem;
            font-weight: bold;
            min-width: 70px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .effect-slider {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: #ddd;
            border-radius: 3px;
        }

        .effect-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--purple);
            border-radius: 50%;
            cursor: pointer;
        }

        .effect-slider-value {
            font-size: 0.8rem;
            font-weight: bold;
            min-width: 40px;
            text-align: right;
            color: var(--purple);
        }

        .mic-recording-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-top: 10px;
        }

        .mic-recording-item audio { flex: 1; height: 36px; }

        .mic-recording-item .delete-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            background: var(--red);
            color: white;
            cursor: pointer;
        }

        .monitor-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: #f0f8ff;
            border-radius: 10px;
            margin-bottom: 12px;
            border: 2px solid var(--blue);
        }

        .tempo-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .tempo-slider {
            flex: 1;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(90deg, var(--blue), var(--purple));
            border-radius: 4px;
        }

        .tempo-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .tempo-value { font-weight: bold; min-width: 70px; text-align: right; }

        .recording-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 12px;
            font-size: 0.9rem;
        }

        .recording-status.active { background: #ffe0e0; color: var(--red); }

        .rec-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ccc;
        }

        .recording-status.active .rec-dot {
            background: var(--red);
            animation: rec-blink 1s infinite;
        }

        @keyframes rec-blink { 50% { opacity: 0.3; } }

        .saved-recordings { margin-top: 12px; }

        .saved-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 6px;
            font-size: 0.9rem;
        }

        .saved-item button {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .saved-item .play { background: var(--green); color: white; }
        .saved-item .delete { background: var(--red); color: white; }

        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        .confetti {
            position: absolute;
            animation: confetti-fall 3s ease-out forwards;
        }

        @keyframes confetti-fall {
            0% { transform: translateY(-10px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .status-toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            padding: 14px 28px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            border-radius: 50px;
            font-size: 1rem;
            z-index: 1000;
            transition: transform 0.3s ease;
            pointer-events: none;
        }

        .status-toast.show { transform: translateX(-50%) translateY(0); }

        .footer {
            text-align: center;
            padding: 30px 20px;
            color: white;
            opacity: 0.8;
            font-size: 0.95rem;
            position: relative;
            z-index: 1;
        }

        @media (max-width: 600px) {
            .header-content { flex-direction: column; gap: 12px; }
            .header-controls { width: 100%; justify-content: space-between; }
            .volume-control { flex: 1; }
            .visualizer-canvas { height: 70px; }
            .bento-card.large { grid-column: span 2; }
        }

        /* SOUND EFFECTS PANEL - For editing individual sounds */
        .sound-fx-panel {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, rgba(102, 126, 234, 0.98) 0%, rgba(118, 75, 162, 0.98) 100%);
            backdrop-filter: blur(20px);
            border-radius: 24px 24px 0 0;
            padding: 20px;
            z-index: 500;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease;
            max-height: 70vh;
            overflow-y: auto;
        }

        .sound-fx-panel.show { display: block; }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .fx-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255,255,255,0.2);
        }

        .fx-panel-title {
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
            font-size: 1.3rem;
            font-weight: bold;
        }

        .fx-panel-title .sound-emoji {
            font-size: 2.5rem;
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 16px;
        }

        .fx-panel-close {
            width: 44px;
            height: 44px;
            border: none;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .fx-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        @media (min-width: 600px) {
            .fx-controls { grid-template-columns: repeat(4, 1fr); }
        }

        .fx-control-item {
            background: rgba(255,255,255,0.15);
            border-radius: 16px;
            padding: 15px;
            text-align: center;
        }

        .fx-control-label {
            display: block;
            color: rgba(255,255,255,0.8);
            font-size: 0.85rem;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .fx-control-emoji {
            font-size: 1.8rem;
            display: block;
            margin-bottom: 8px;
        }

        .fx-slider {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .fx-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .fx-value {
            color: white;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .fx-quick-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .fx-quick-btn {
            padding: 14px 20px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }

        .fx-quick-btn:active {
            transform: translateY(3px);
            box-shadow: 0 1px 0 rgba(0,0,0,0.2);
        }

        .fx-quick-btn.reverse { background: #FF6B9D; color: white; }
        .fx-quick-btn.echo { background: #9B59B6; color: white; }
        .fx-quick-btn.underwater { background: #3498DB; color: white; }
        .fx-quick-btn.space { background: #1a1a2e; color: white; }
        .fx-quick-btn.chipmunk { background: #F1C40F; color: #333; }
        .fx-quick-btn.monster { background: #2ECC71; color: white; }
        .fx-quick-btn.robot { background: #7F8C8D; color: white; }
        .fx-quick-btn.favorite { background: #E74C3C; color: white; }
        .fx-quick-btn.favorite.active { background: #FFD700; }

        .fx-action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 15px;
        }

        .fx-action-btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 16px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }

        .fx-action-btn:active {
            transform: translateY(3px);
            box-shadow: 0 1px 0 rgba(0,0,0,0.2);
        }

        .fx-action-btn.play { background: var(--green); color: white; }
        .fx-action-btn.add-mixer { background: var(--purple); color: white; }
        .fx-action-btn.stop { background: var(--red); color: white; }

        /* FAVORITES SECTION */
        .favorites-section {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 107, 157, 0.15));
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .favorites-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .favorites-title {
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .favorites-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .favorite-sound {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 12px;
            font-size: 1.5rem;
            cursor: pointer;
            position: relative;
            box-shadow: 0 3px 0 rgba(0,0,0,0.2);
        }

        .favorite-sound:active {
            transform: translateY(2px);
            box-shadow: 0 1px 0 rgba(0,0,0,0.2);
        }

        .favorite-sound .remove-fav {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--red);
            color: white;
            border: none;
            font-size: 0.7rem;
            cursor: pointer;
            display: none;
        }

        .favorite-sound:hover .remove-fav { display: block; }

        .favorites-empty {
            color: #999;
            font-size: 0.85rem;
            padding: 10px;
        }

        /* SCENE MODES */
        .scene-modes {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .scene-mode-btn {
            padding: 10px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            background: white;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .scene-mode-btn:hover { border-color: var(--purple); }
        .scene-mode-btn.active {
            background: var(--purple);
            color: white;
            border-color: var(--purple);
            box-shadow: 0 4px 15px rgba(155, 89, 182, 0.4);
        }

        /* SEQUENCER */
        .mini-sequencer {
            background: linear-gradient(135deg, rgba(26, 188, 156, 0.1), rgba(52, 152, 219, 0.1));
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .sequencer-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .sequencer-title {
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sequencer-controls {
            display: flex;
            gap: 8px;
        }

        .seq-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1rem;
        }

        .seq-btn.play { background: var(--green); color: white; }
        .seq-btn.stop { background: var(--red); color: white; }
        .seq-btn.clear { background: #ddd; color: #666; }

        .sequencer-grid {
            display: flex;
            gap: 6px;
            overflow-x: auto;
            padding: 10px 0;
        }

        .seq-step {
            width: 40px;
            height: 50px;
            border: 2px dashed #ccc;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            cursor: pointer;
            background: white;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }

        .seq-step.filled {
            border-style: solid;
            border-color: var(--purple);
            background: linear-gradient(135deg, rgba(155, 89, 182, 0.1), rgba(102, 126, 234, 0.1));
        }

        .seq-step.playing {
            transform: scale(1.1);
            box-shadow: 0 0 15px var(--purple);
        }

        .seq-step.empty::after {
            content: '+';
            color: #ccc;
            font-size: 1.5rem;
        }

        .seq-step.drag-over {
            border-color: var(--green);
            border-style: solid;
            background: rgba(46, 204, 113, 0.2);
            transform: scale(1.1);
            box-shadow: 0 0 15px var(--green);
        }

        .sound-btn.dragging {
            opacity: 0.5;
            transform: scale(0.9);
        }

        .sound-btn[draggable="true"] {
            cursor: grab;
        }

        .sound-btn[draggable="true"]:active {
            cursor: grabbing;
        }

        /* Sound button with edit indicator */
        .sound-btn.has-fx::before {
            content: '⚡';
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 0.8rem;
            background: var(--purple);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="bubbles" id="bubbles"></div>
    <div class="confetti-container" id="confetti"></div>
    <div class="status-toast" id="statusToast"></div>

    <header class="top-header">
        <div class="header-content">
            <div class="logo-section">
                <h1>Julia's Playbox</h1>
            </div>
            <div class="main-tabs">
                <button class="main-tab active" onclick="switchMainTab('music', this)">
                    <span class="tab-icon">🎵</span>
                    <span>Music</span>
                </button>
                <button class="main-tab" onclick="switchMainTab('paint', this)">
                    <span class="tab-icon">🎨</span>
                    <span>Paint</span>
                </button>
            </div>
            <div class="header-controls">
                <div class="volume-control" id="musicControls">
                    <span>🔊</span>
                    <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="80">
                </div>
                <button class="settings-toggle" id="settingsToggle" onclick="toggleSettingsPanel()">
                    <span>⚙️</span>
                    <span>Settings</span>
                </button>
            </div>
        </div>
    </header>

    <!-- MUSIC TAB -->
    <div class="tab-content active" id="musicTab">
        <div class="settings-panel" id="settingsPanel">
            <div class="settings-content">
                <div class="setting-item">
                    <span>🎆 Effects</span>
                    <div class="toggle on" id="toggleEffects" onclick="toggleSetting('effects', this)"></div>
                </div>
                <div class="setting-item">
                    <span>🫧 Bubbles</span>
                    <div class="toggle on" id="toggleBubbles" onclick="toggleSetting('bubbles', this)"></div>
                </div>
                <div class="setting-item">
                    <span>🎉 Confetti</span>
                    <div class="toggle on" id="toggleConfetti" onclick="toggleSetting('confetti', this)"></div>
                </div>
            </div>
        </div>

        <section class="visualizer-section">
        <div class="visualizer-container">
            <canvas class="visualizer-canvas" id="visualizer"></canvas>
        </div>
    </section>

    <main class="main-content">
        <div class="bento-grid">
            <!-- Music Instruments Card - Full Width -->
            <div class="bento-card full">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">🎼</span>
                        <span class="card-name">Music Instruments</span>
                    </div>
                    <button class="more-btn" onclick="toggleMore(this)">+</button>
                </div>
                <div class="card-content">
                    <div class="instrument-selector">
                        <button class="instrument-chip active" onclick="switchInstrument('piano', this)">
                            <span class="chip-icon">🎹</span> Piano
                        </button>
                        <button class="instrument-chip" onclick="switchInstrument('drums', this)">
                            <span class="chip-icon">🥁</span> Drums
                        </button>
                        <button class="instrument-chip" onclick="switchInstrument('xylophone', this)">
                            <span class="chip-icon">🎵</span> Xylophone
                        </button>
                        <button class="instrument-chip" onclick="switchInstrument('guitar', this)">
                            <span class="chip-icon">🎸</span> Guitar
                        </button>
                        <button class="instrument-chip" onclick="switchInstrument('harp', this)">
                            <span class="chip-icon">🪕</span> Harp
                        </button>
                        <button class="instrument-chip" onclick="switchInstrument('kalimba', this)">
                            <span class="chip-icon">🪘</span> Kalimba
                        </button>
                        <button class="instrument-chip" onclick="switchInstrument('steeldrums', this)">
                            <span class="chip-icon">🪩</span> Steel Drums
                        </button>
                        <button class="instrument-chip" onclick="switchInstrument('organ', this)">
                            <span class="chip-icon">⛪</span> Organ
                        </button>
                        <button class="instrument-chip" onclick="switchInstrument('marimba', this)">
                            <span class="chip-icon">🎶</span> Marimba
                        </button>
                        <button class="instrument-chip" onclick="switchInstrument('flute', this)">
                            <span class="chip-icon">🎐</span> Flute
                        </button>
                        <button class="instrument-chip" onclick="switchInstrument('bells', this)">
                            <span class="chip-icon">🔔</span> Bells
                        </button>
                        <button class="instrument-chip" onclick="switchInstrument('bass', this)">
                            <span class="chip-icon">🎻</span> Bass
                        </button>
                        <button class="instrument-chip" onclick="switchInstrument('synth', this)">
                            <span class="chip-icon">🎛️</span> Synth
                        </button>
                        <button class="instrument-chip" onclick="switchInstrument('chimes', this)">
                            <span class="chip-icon">🎁</span> Music Box
                        </button>
                        <button class="instrument-chip" onclick="switchInstrument('trumpet', this)">
                            <span class="chip-icon">🎺</span> Trumpet
                        </button>
                    </div>
                    <div id="instrument-piano" class="instrument-area">
                        <div class="piano-container">
                            <div class="piano" id="piano"></div>
                        </div>
                    </div>
                    <div id="instrument-drums" class="instrument-area" style="display:none;">
                        <div class="drum-grid" id="drumPads"></div>
                    </div>
                    <div id="instrument-xylophone" class="instrument-area" style="display:none;">
                        <div class="xylo-grid" id="xylophone"></div>
                    </div>
                    <div id="instrument-guitar" class="instrument-area" style="display:none;">
                        <div class="guitar-grid" id="guitarStrings"></div>
                    </div>
                    <div id="instrument-harp" class="instrument-area" style="display:none;">
                        <div class="harp-grid" id="harpStrings"></div>
                    </div>
                    <div id="instrument-kalimba" class="instrument-area" style="display:none;">
                        <div class="kalimba-grid" id="kalimbaKeys"></div>
                    </div>
                    <div id="instrument-steeldrums" class="instrument-area" style="display:none;">
                        <div class="steeldrums-grid" id="steelDrums"></div>
                    </div>
                    <div id="instrument-organ" class="instrument-area" style="display:none;">
                        <div class="organ-grid" id="organKeys"></div>
                    </div>
                    <div id="instrument-marimba" class="instrument-area" style="display:none;">
                        <div class="marimba-grid" id="marimbaKeys"></div>
                    </div>
                    <div id="instrument-flute" class="instrument-area" style="display:none;">
                        <div class="flute-grid" id="fluteNotes"></div>
                    </div>
                    <div id="instrument-bells" class="instrument-area" style="display:none;">
                        <div class="bells-grid" id="bellsGrid"></div>
                    </div>
                    <div id="instrument-bass" class="instrument-area" style="display:none;">
                        <div class="bass-grid" id="bassGrid"></div>
                    </div>
                    <div id="instrument-synth" class="instrument-area" style="display:none;">
                        <div class="synth-grid" id="synthGrid"></div>
                    </div>
                    <div id="instrument-chimes" class="instrument-area" style="display:none;">
                        <div class="chimes-grid" id="chimesKeys"></div>
                    </div>
                    <div id="instrument-trumpet" class="instrument-area" style="display:none;">
                        <div class="trumpet-grid" id="trumpetNotes"></div>
                    </div>
                </div>
                <div class="card-more">
                    <p style="font-size: 0.85rem; color: #666; margin-bottom: 10px;">Keyboard shortcuts (Piano):</p>
                    <p style="font-size: 0.8rem; color: #888;">White keys: A S D F G H J K | Black keys: W E T Y U</p>
                    <p style="font-size: 0.85rem; color: #666; margin: 10px 0 5px;">15 instruments to explore!</p>
                    <p style="font-size: 0.8rem; color: #888;">Piano, Drums, Xylophone, Guitar, Harp, Kalimba, Steel Drums, Organ, Marimba, Flute, Bells, Bass, Synth, Music Box & Trumpet</p>
                </div>
            </div>

            <!-- Fun Sounds Card -->
            <div class="bento-card large">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">🎉</span>
                        <span class="card-name">Fun Sounds</span>
                        <span id="soundLoadingIndicator" style="font-size: 0.7rem; color: #999; display: none;">Loading...</span>
                    </div>
                    <button class="more-btn" onclick="toggleMore(this)">+</button>
                </div>
                <div class="card-content">
                    <!-- Scene Modes - Fun effect presets -->
                    <div class="scene-modes">
                        <button class="scene-mode-btn active" onclick="setSceneMode('normal', this)">🎵 Normal</button>
                        <button class="scene-mode-btn" onclick="setSceneMode('underwater', this)">🌊 Underwater</button>
                        <button class="scene-mode-btn" onclick="setSceneMode('space', this)">🚀 Space</button>
                        <button class="scene-mode-btn" onclick="setSceneMode('cave', this)">🦇 Cave</button>
                        <button class="scene-mode-btn" onclick="setSceneMode('fairy', this)">🧚 Fairy</button>
                    </div>

                    <div class="sound-controls">
                        <button class="sound-control-btn" id="loopModeBtn" onclick="toggleLoopMode()">🔁 Loop</button>
                        <button class="sound-control-btn" onclick="openLoopSettings()">⚙️ Settings</button>
                        <button class="sound-control-btn" onclick="stopAllSounds()">⏹️ Stop All</button>
                        <button class="sound-control-btn" id="mixerToggleBtn" onclick="toggleMixer()">🎚️ Mixer</button>
                        <button class="sound-control-btn" id="editModeBtn" onclick="toggleEditMode()">✏️ Edit</button>
                    </div>

                    <!-- Favorites Section -->
                    <div class="favorites-section" id="favoritesSection">
                        <div class="favorites-header">
                            <span class="favorites-title">⭐ Julia's Favorites</span>
                        </div>
                        <div class="favorites-grid" id="favoritesGrid">
                            <span class="favorites-empty">Long-press any sound to add to favorites!</span>
                        </div>
                    </div>

                    <!-- Mini Sequencer -->
                    <div class="mini-sequencer">
                        <div class="sequencer-header">
                            <span class="sequencer-title">🎼 Beat Maker</span>
                            <div class="sequencer-controls">
                                <button class="seq-btn play" onclick="playSequence()">▶️</button>
                                <button class="seq-btn stop" onclick="stopSequence()">⏹️</button>
                                <button class="seq-btn clear" onclick="clearSequence()">🗑️</button>
                            </div>
                        </div>
                        <div class="sequencer-grid" id="sequencerGrid">
                            <!-- Steps will be generated by JS -->
                        </div>
                    </div>

                    <!-- Sound Mixer -->
                    <div class="sound-mixer" id="soundMixer" style="display: none;">
                        <div class="mixer-header">
                            <div class="mixer-title">🎚️ Sound Mixer</div>
                            <button class="sound-control-btn" onclick="playAllMixer()" style="padding: 6px 12px; font-size: 0.8rem;">▶️ Play All</button>
                        </div>
                        <div class="mixer-tracks" id="mixerTracks">
                            <div class="mixer-empty">Tap ➕ on any sound to add it here!</div>
                        </div>
                    </div>

                    <!-- Category Tabs -->
                    <div class="category-tabs" id="categoryTabs"></div>

                    <!-- Sound Grid -->
                    <div id="soundGrid" class="category-sounds"></div>
                </div>
                <div class="card-more">
                    <p style="font-size: 0.85rem; color: #666; margin-bottom: 10px;">🎵 Real Sounds from Freesound.org!</p>
                    <p style="font-size: 0.8rem; color: #888;">• Tap a sound to play it</p>
                    <p style="font-size: 0.8rem; color: #888;">• Long-press or right-click to add to mixer</p>
                    <p style="font-size: 0.8rem; color: #888;">• Enable Loop Mode for repeating sounds</p>
                    <p style="font-size: 0.8rem; color: #888;">• Use Mixer to combine multiple sounds!</p>
                </div>
            </div>

            <!-- Loop Settings Modal -->
            <div class="loop-modal" id="loopModal">
                <div class="loop-modal-content">
                    <div class="loop-modal-header">
                        <div class="loop-modal-title">⚙️ Loop Settings</div>
                        <button class="loop-modal-close" onclick="closeLoopSettings()">✕</button>
                    </div>

                    <div class="loop-setting">
                        <label class="loop-setting-label">🔄 Loop Count</label>
                        <div class="loop-setting-options">
                            <button class="loop-option" onclick="setLoopCount(1, this)">1×</button>
                            <button class="loop-option" onclick="setLoopCount(2, this)">2×</button>
                            <button class="loop-option" onclick="setLoopCount(3, this)">3×</button>
                            <button class="loop-option" onclick="setLoopCount(5, this)">5×</button>
                            <button class="loop-option selected" onclick="setLoopCount(-1, this)">∞</button>
                        </div>
                    </div>

                    <div class="loop-setting">
                        <label class="loop-setting-label">⏱️ Loop Interval (ms)</label>
                        <div class="loop-slider-container">
                            <input type="range" class="loop-slider" id="loopIntervalSlider" min="200" max="2000" value="500" oninput="updateLoopInterval(this.value)">
                            <span class="loop-slider-value" id="loopIntervalValue">500ms</span>
                        </div>
                    </div>

                    <div class="loop-setting">
                        <label class="loop-setting-label">🎵 Playback Speed</label>
                        <div class="loop-slider-container">
                            <input type="range" class="loop-slider" id="playbackSpeedSlider" min="50" max="200" value="100" oninput="updatePlaybackSpeed(this.value)">
                            <span class="loop-slider-value" id="playbackSpeedValue">1.0×</span>
                        </div>
                    </div>

                    <div class="loop-modal-actions">
                        <button class="loop-modal-btn secondary" onclick="closeLoopSettings()">Cancel</button>
                        <button class="loop-modal-btn primary" onclick="saveLoopSettings()">Save</button>
                    </div>
                </div>
            </div>

            <!-- Music Tracks Card -->
            <div class="bento-card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">🎸</span>
                        <span class="card-name">Music Tracks</span>
                    </div>
                    <button class="more-btn" onclick="toggleMore(this)">+</button>
                </div>
                <div class="card-content">
                    <div class="track-grid" id="trackList"></div>
                </div>
                <div class="card-more">
                    <div class="tempo-row">
                        <span>🎵</span>
                        <input type="range" class="tempo-slider" id="tempoSlider" min="60" max="180" value="120">
                        <span class="tempo-value" id="tempoValue">120 BPM</span>
                    </div>
                </div>
            </div>

            <!-- Voice Changer Card -->
            <div class="bento-card large">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">🎤</span>
                        <span class="card-name">Voice Changer</span>
                    </div>
                    <button class="more-btn" onclick="toggleMore(this)">+</button>
                </div>
                <div class="card-content">
                    <div class="mic-status-bar">
                        <div class="mic-dot" id="micDot"></div>
                        <span id="micStatus" style="font-size: 0.85rem; flex-shrink: 0;">Not connected</span>
                        <div class="mic-level">
                            <div class="mic-level-fill" id="micLevel"></div>
                        </div>
                    </div>
                    <div class="card-actions" style="margin-bottom: 12px;">
                        <button class="action-btn green" id="micConnectBtn" onclick="connectMicrophone()">🎤 Connect</button>
                        <button class="action-btn red" id="micRecordBtn" onclick="toggleMicRecording()" disabled>⏺️ Record</button>
                        <button class="action-btn orange" id="micStopBtn" onclick="disconnectMicrophone()" disabled>⏹️ Stop</button>
                    </div>
                    <div class="monitor-toggle" id="monitorToggle">
                        <span style="font-size: 1.2rem;">🎧</span>
                        <div style="flex: 1;">
                            <label style="display: block;">Hear yourself (with effects!)</label>
                            <span style="font-size: 0.75rem; color: #666;">Use headphones to avoid feedback</span>
                        </div>
                        <div class="toggle" id="monitorSwitch" onclick="toggleMonitor()"></div>
                    </div>
                    <div class="voice-effects">
                        <span class="effect-label">🎭 Voice Effects:</span>
                        <div class="effect-chips">
                            <button class="effect-chip active" onclick="setVoiceEffect('normal', this)">😊 Normal</button>
                            <button class="effect-chip" onclick="setVoiceEffect('robot', this)">🤖 Robot</button>
                            <button class="effect-chip" onclick="setVoiceEffect('chipmunk', this)">🐿️ Chipmunk</button>
                            <button class="effect-chip" onclick="setVoiceEffect('monster', this)">👹 Monster</button>
                            <button class="effect-chip" onclick="setVoiceEffect('echo', this)">🔊 Echo</button>
                            <button class="effect-chip" onclick="setVoiceEffect('alien', this)">👽 Alien</button>
                        </div>
                    </div>
                </div>
                <div class="card-more">
                    <div class="effect-slider-row">
                        <span class="effect-slider-label">🎚️ Pitch</span>
                        <input type="range" class="effect-slider" id="pitchSlider" min="-12" max="12" value="0" oninput="updatePitch(this.value)">
                        <span class="effect-slider-value" id="pitchValue">0</span>
                    </div>
                    <div class="effect-slider-row">
                        <span class="effect-slider-label">🔁 Echo</span>
                        <input type="range" class="effect-slider" id="echoSlider" min="0" max="100" value="0" oninput="updateEcho(this.value)">
                        <span class="effect-slider-value" id="echoValue">0%</span>
                    </div>
                    <div class="effect-slider-row">
                        <span class="effect-slider-label">⏱️ Delay</span>
                        <input type="range" class="effect-slider" id="delaySlider" min="0" max="500" value="0" oninput="updateDelay(this.value)">
                        <span class="effect-slider-value" id="delayValue">0ms</span>
                    </div>
                    <div class="effect-slider-row">
                        <span class="effect-slider-label">🌊 Reverb</span>
                        <input type="range" class="effect-slider" id="reverbSlider" min="0" max="100" value="0" oninput="updateReverb(this.value)">
                        <span class="effect-slider-value" id="reverbValue">0%</span>
                    </div>
                    <div class="effect-slider-row">
                        <span class="effect-slider-label">📢 Gain</span>
                        <input type="range" class="effect-slider" id="gainSlider" min="0" max="200" value="100" oninput="updateGain(this.value)">
                        <span class="effect-slider-value" id="gainValue">100%</span>
                    </div>
                    <p style="font-size: 0.85rem; font-weight: bold; color: #666; margin: 15px 0 10px;">🎙️ Recordings:</p>
                    <div id="micRecordings"></div>
                </div>
            </div>

            <!-- Record Notes Card -->
            <div class="bento-card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">🎙️</span>
                        <span class="card-name">Record Notes</span>
                    </div>
                    <button class="more-btn" onclick="toggleMore(this)">+</button>
                </div>
                <div class="card-content">
                    <div class="recording-status" id="recStatus">
                        <div class="rec-dot"></div>
                        <span>Ready to record your music</span>
                    </div>
                    <div class="card-actions">
                        <button class="action-btn red" id="recBtn" onclick="toggleRecording()">⏺️ Record</button>
                        <button class="action-btn green" onclick="playRecording()">▶️ Play</button>
                        <button class="action-btn orange" onclick="clearRecording()">🗑️</button>
                    </div>
                </div>
                <div class="card-more">
                    <p style="font-size: 0.85rem; color: #666; margin-bottom: 10px;">Saved recordings:</p>
                    <div class="saved-recordings" id="savedRecordings"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Sound Effects Panel - Opens when editing a sound -->
    <div class="sound-fx-panel" id="soundFxPanel">
        <div class="fx-panel-header">
            <div class="fx-panel-title">
                <span class="sound-emoji" id="fxPanelEmoji">🐱</span>
                <div>
                    <span id="fxPanelName">Cat</span>
                    <div style="font-size: 0.8rem; opacity: 0.8;">Edit this sound!</div>
                </div>
            </div>
            <button class="fx-panel-close" onclick="closeFxPanel()">✕</button>
        </div>

        <!-- Quick Effect Buttons -->
        <div class="fx-quick-buttons">
            <button class="fx-quick-btn reverse" onclick="applyQuickFx('reverse')">⏪ Reverse</button>
            <button class="fx-quick-btn echo" onclick="applyQuickFx('echo')">🔊 Echo</button>
            <button class="fx-quick-btn underwater" onclick="applyQuickFx('underwater')">🌊 Underwater</button>
            <button class="fx-quick-btn space" onclick="applyQuickFx('space')">🚀 Space</button>
            <button class="fx-quick-btn chipmunk" onclick="applyQuickFx('chipmunk')">🐿️ Chipmunk</button>
            <button class="fx-quick-btn monster" onclick="applyQuickFx('monster')">👹 Monster</button>
            <button class="fx-quick-btn robot" onclick="applyQuickFx('robot')">🤖 Robot</button>
            <button class="fx-quick-btn favorite" id="fxFavoriteBtn" onclick="toggleFavorite()">⭐ Favorite</button>
        </div>

        <!-- Detailed Controls -->
        <div class="fx-controls">
            <div class="fx-control-item">
                <span class="fx-control-emoji">🎵</span>
                <label class="fx-control-label">Pitch</label>
                <input type="range" class="fx-slider" id="fxPitchSlider" min="-12" max="12" value="0" oninput="updateFxPitch(this.value)">
                <span class="fx-value" id="fxPitchValue">0</span>
            </div>
            <div class="fx-control-item">
                <span class="fx-control-emoji">🏃</span>
                <label class="fx-control-label">Speed</label>
                <input type="range" class="fx-slider" id="fxSpeedSlider" min="25" max="200" value="100" oninput="updateFxSpeed(this.value)">
                <span class="fx-value" id="fxSpeedValue">1.0x</span>
            </div>
            <div class="fx-control-item">
                <span class="fx-control-emoji">🔊</span>
                <label class="fx-control-label">Echo</label>
                <input type="range" class="fx-slider" id="fxEchoSlider" min="0" max="100" value="0" oninput="updateFxEcho(this.value)">
                <span class="fx-value" id="fxEchoValue">0%</span>
            </div>
            <div class="fx-control-item">
                <span class="fx-control-emoji">🔉</span>
                <label class="fx-control-label">Volume</label>
                <input type="range" class="fx-slider" id="fxVolumeSlider" min="0" max="150" value="100" oninput="updateFxVolume(this.value)">
                <span class="fx-value" id="fxVolumeValue">100%</span>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="fx-action-buttons">
            <button class="fx-action-btn play" onclick="playWithFx()">▶️ Play</button>
            <button class="fx-action-btn add-mixer" onclick="addToMixerWithFx()">🎚️ Add to Mixer</button>
            <button class="fx-action-btn stop" onclick="stopCurrentFx()">⏹️ Stop</button>
        </div>
    </div>
    </div><!-- END MUSIC TAB -->

    <!-- PAINT TAB -->
    <div class="tab-content" id="paintTab">
        <div class="paint-container">
            <div class="paint-toolbar">
                <div class="paint-colors" id="paintColors">
                    <!-- Colors will be generated by JS -->
                </div>
                <div class="brush-size-control">
                    <label>Brush:</label>
                    <input type="range" class="brush-slider" id="brushSize" min="2" max="80" value="15">
                    <div class="brush-preview">
                        <div class="brush-dot" id="brushPreview"></div>
                    </div>
                </div>
                <div class="paint-actions">
                    <button class="paint-btn eraser" id="eraserBtn" onclick="toggleEraser()">🧹 Eraser</button>
                    <button class="paint-btn undo" onclick="undoPaint()">↩️ Undo</button>
                    <button class="paint-btn clear" onclick="clearCanvas()">🗑️ Clear</button>
                    <button class="paint-btn save" onclick="saveCanvas()">💾 Save</button>
                </div>
            </div>
            <div class="canvas-wrapper">
                <canvas id="paintCanvas"></canvas>
            </div>
        </div>
    </div><!-- END PAINT TAB -->

    <footer class="footer">Made with love for Julia</footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js"></script>
    <script>
        // ============================================
        // FREESOUND API CONFIGURATION
        // ============================================
        const FREESOUND_API_KEY = '8DEc3afcbTYBx00oJ908Ix1NIXIuRnzA2lEWldBA';
        const FREESOUND_API_URL = 'https://freesound.org/apiv2';

        // Sound categories with search queries and emojis
        const soundCategories = {
            animals: {
                name: '🐾 Animals',
                icon: '🐾',
                color: '#FF6B9D',
                sounds: [
                    { emoji: '🐱', name: 'Cat', query: 'cat meow', color: '#FF6B9D' },
                    { emoji: '🐶', name: 'Dog', query: 'dog bark', color: '#9B59B6' },
                    { emoji: '🐦', name: 'Bird', query: 'bird chirp', color: '#3498DB' },
                    { emoji: '🐸', name: 'Frog', query: 'frog croak', color: '#2ECC71' },
                    { emoji: '🦁', name: 'Lion', query: 'lion roar', color: '#F1C40F' },
                    { emoji: '🐄', name: 'Cow', query: 'cow moo', color: '#E67E22' },
                    { emoji: '🐷', name: 'Pig', query: 'pig squeal', color: '#FFB6C1' },
                    { emoji: '🐴', name: 'Horse', query: 'horse neigh', color: '#8B4513' },
                    { emoji: '🦆', name: 'Duck', query: 'duck quack', color: '#FFD700' },
                    { emoji: '🐝', name: 'Bee', query: 'bee buzzing', color: '#F4D03F' },
                    { emoji: '🦉', name: 'Owl', query: 'owl hoot', color: '#6C3483' },
                    { emoji: '🐺', name: 'Wolf', query: 'wolf howl', color: '#5D6D7E' },
                    { emoji: '🐘', name: 'Elephant', query: 'elephant', color: '#95A5A6' },
                    { emoji: '🐒', name: 'Monkey', query: 'monkey', color: '#D35400' },
                    { emoji: '🐔', name: 'Chicken', query: 'chicken', color: '#E74C3C' },
                    { emoji: '🐑', name: 'Sheep', query: 'sheep', color: '#ECF0F1' },
                    { emoji: '🐐', name: 'Goat', query: 'goat', color: '#BDC3C7' },
                    { emoji: '🦃', name: 'Turkey', query: 'turkey', color: '#C0392B' }
                ]
            },
            nature: {
                name: '🌿 Nature',
                icon: '🌿',
                color: '#2ECC71',
                sounds: [
                    { emoji: '🌧️', name: 'Rain', query: 'rain', color: '#3498DB' },
                    { emoji: '⛈️', name: 'Thunder', query: 'thunder', color: '#9B59B6' },
                    { emoji: '💨', name: 'Wind', query: 'wind', color: '#85C1E9' },
                    { emoji: '🌊', name: 'Ocean', query: 'ocean waves', color: '#1ABC9C' },
                    { emoji: '🏞️', name: 'River', query: 'river', color: '#3498DB' },
                    { emoji: '🔥', name: 'Fire', query: 'fire crackling', color: '#E74C3C' },
                    { emoji: '🌲', name: 'Forest', query: 'forest', color: '#27AE60' },
                    { emoji: '🦗', name: 'Crickets', query: 'crickets', color: '#1E8449' },
                    { emoji: '⚡', name: 'Lightning', query: 'lightning', color: '#F7DC6F' },
                    { emoji: '❄️', name: 'Snow', query: 'blizzard', color: '#AED6F1' },
                    { emoji: '🌴', name: 'Jungle', query: 'jungle', color: '#28B463' },
                    { emoji: '🏜️', name: 'Desert', query: 'desert wind', color: '#F5B041' }
                ]
            },
            instruments: {
                name: '🎵 Instruments',
                icon: '🎵',
                color: '#9B59B6',
                sounds: [
                    { emoji: '🎺', name: 'Trumpet', query: 'trumpet', color: '#E74C3C' },
                    { emoji: '🔔', name: 'Bell', query: 'bell', color: '#1ABC9C' },
                    { emoji: '🎷', name: 'Saxophone', query: 'saxophone', color: '#F39C12' },
                    { emoji: '🎻', name: 'Violin', query: 'violin', color: '#8E44AD' },
                    { emoji: '🎸', name: 'Guitar', query: 'guitar', color: '#C0392B' },
                    { emoji: '🪈', name: 'Flute', query: 'flute', color: '#5DADE2' },
                    { emoji: '🎹', name: 'Piano', query: 'piano', color: '#2C3E50' },
                    { emoji: '🥁', name: 'Drums', query: 'drum', color: '#E74C3C' },
                    { emoji: '🪗', name: 'Accordion', query: 'accordion', color: '#E91E63' },
                    { emoji: '🎤', name: 'Vocal', query: 'choir', color: '#9C27B0' },
                    { emoji: '🪘', name: 'Bongo', query: 'bongo', color: '#795548' },
                    { emoji: '🎶', name: 'Harp', query: 'harp', color: '#FFD700' }
                ]
            },
            effects: {
                name: '✨ Effects',
                icon: '✨',
                color: '#F39C12',
                sounds: [
                    { emoji: '💥', name: 'Explosion', query: 'explosion', color: '#E74C3C' },
                    { emoji: '✨', name: 'Magic', query: 'magic spell', color: '#F39C12' },
                    { emoji: '🚀', name: 'Rocket', query: 'rocket', color: '#C0392B' },
                    { emoji: '👻', name: 'Ghost', query: 'ghost', color: '#BDC3C7' },
                    { emoji: '🤖', name: 'Robot', query: 'robot', color: '#7F8C8D' },
                    { emoji: '👾', name: 'Alien', query: 'alien', color: '#9B59B6' },
                    { emoji: '⚔️', name: 'Sword', query: 'sword', color: '#95A5A6' },
                    { emoji: '🎃', name: 'Spooky', query: 'halloween', color: '#E67E22' },
                    { emoji: '💫', name: 'Twinkle', query: 'sparkle', color: '#F4D03F' },
                    { emoji: '🎈', name: 'Pop', query: 'pop', color: '#E74C3C' },
                    { emoji: '🪄', name: 'Wand', query: 'magic wand', color: '#8E44AD' },
                    { emoji: '💎', name: 'Crystal', query: 'crystal', color: '#00BCD4' }
                ]
            },
            transport: {
                name: '🚗 Transport',
                icon: '🚗',
                color: '#3498DB',
                sounds: [
                    { emoji: '🚗', name: 'Car', query: 'car engine', color: '#2980B9' },
                    { emoji: '🚂', name: 'Train', query: 'train whistle', color: '#7F8C8D' },
                    { emoji: '✈️', name: 'Airplane', query: 'airplane', color: '#5DADE2' },
                    { emoji: '🚁', name: 'Helicopter', query: 'helicopter', color: '#1ABC9C' },
                    { emoji: '🚢', name: 'Ship', query: 'ship horn', color: '#34495E' },
                    { emoji: '🏎️', name: 'Race Car', query: 'racing car', color: '#E74C3C' },
                    { emoji: '🚑', name: 'Ambulance', query: 'ambulance', color: '#E74C3C' },
                    { emoji: '🚒', name: 'Fire Truck', query: 'fire truck', color: '#C0392B' },
                    { emoji: '🚓', name: 'Police', query: 'police siren', color: '#3498DB' },
                    { emoji: '🛵', name: 'Motorcycle', query: 'motorcycle', color: '#E67E22' },
                    { emoji: '🚲', name: 'Bicycle', query: 'bike bell', color: '#27AE60' },
                    { emoji: '🛸', name: 'UFO', query: 'ufo', color: '#9B59B6' }
                ]
            },
            fun: {
                name: '🎉 Fun',
                icon: '🎉',
                color: '#E91E63',
                sounds: [
                    { emoji: '😂', name: 'Laugh', query: 'laugh', color: '#F1C40F' },
                    { emoji: '👏', name: 'Applause', query: 'applause', color: '#E74C3C' },
                    { emoji: '🎊', name: 'Party', query: 'party horn', color: '#E91E63' },
                    { emoji: '📯', name: 'Fanfare', query: 'fanfare', color: '#F1C40F' },
                    { emoji: '🥳', name: 'Cheer', query: 'crowd cheer', color: '#9B59B6' },
                    { emoji: '🤣', name: 'Giggle', query: 'giggle', color: '#FF6B9D' },
                    { emoji: '😮', name: 'Gasp', query: 'gasp', color: '#3498DB' },
                    { emoji: '🥁', name: 'Rimshot', query: 'rimshot', color: '#E67E22' },
                    { emoji: '📢', name: 'Airhorn', query: 'air horn', color: '#E74C3C' },
                    { emoji: '🎵', name: 'Whistle', query: 'whistle', color: '#2ECC71' },
                    { emoji: '🔔', name: 'Ding', query: 'ding', color: '#1ABC9C' }
                ]
            },
            household: {
                name: '🏠 Household',
                icon: '🏠',
                color: '#795548',
                sounds: [
                    { emoji: '🚪', name: 'Door', query: 'door creak', color: '#8D6E63' },
                    { emoji: '🔑', name: 'Keys', query: 'keys', color: '#FFD700' },
                    { emoji: '📞', name: 'Phone', query: 'phone ring', color: '#4CAF50' },
                    { emoji: '⏰', name: 'Alarm', query: 'alarm clock', color: '#F44336' },
                    { emoji: '🚿', name: 'Shower', query: 'shower', color: '#2196F3' },
                    { emoji: '🍳', name: 'Cooking', query: 'frying', color: '#FF9800' },
                    { emoji: '☕', name: 'Coffee', query: 'coffee', color: '#795548' },
                    { emoji: '💡', name: 'Switch', query: 'switch click', color: '#FFC107' },
                    { emoji: '🧹', name: 'Vacuum', query: 'vacuum', color: '#607D8B' },
                    { emoji: '📺', name: 'TV', query: 'static', color: '#9E9E9E' },
                    { emoji: '⌨️', name: 'Typing', query: 'typing', color: '#455A64' },
                    { emoji: '🖨️', name: 'Printer', query: 'printer', color: '#78909C' }
                ]
            },
            games: {
                name: '🎮 Games',
                icon: '🎮',
                color: '#00BCD4',
                sounds: [
                    { emoji: '🏆', name: 'Win', query: 'victory', color: '#FFD700' },
                    { emoji: '💔', name: 'Lose', query: 'game over', color: '#E74C3C' },
                    { emoji: '⬆️', name: 'Level Up', query: 'level up', color: '#2ECC71' },
                    { emoji: '💰', name: 'Coin', query: 'coin', color: '#F1C40F' },
                    { emoji: '❤️', name: 'Life', query: 'power up', color: '#E91E63' },
                    { emoji: '💨', name: 'Jump', query: 'jump', color: '#3498DB' },
                    { emoji: '🔫', name: 'Laser', query: 'laser', color: '#E74C3C' },
                    { emoji: '💣', name: 'Bomb', query: 'bomb', color: '#34495E' },
                    { emoji: '🌟', name: 'Star', query: 'collect', color: '#F39C12' },
                    { emoji: '🎯', name: 'Hit', query: 'hit', color: '#9C27B0' },
                    { emoji: '🛡️', name: 'Shield', query: 'shield', color: '#607D8B' },
                    { emoji: '⚡', name: 'Power', query: 'power', color: '#FFEB3B' }
                ]
            },
            dinosaurs: {
                name: '🦖 Dinosaurs',
                icon: '🦖',
                color: '#4CAF50',
                sounds: [
                    { emoji: '🦖', name: 'T-Rex Roar', query: 'dinosaur roar', color: '#4CAF50' },
                    { emoji: '🦕', name: 'Dino Call', query: 'creature call', color: '#8BC34A' },
                    { emoji: '🐊', name: 'Raptor', query: 'raptor screech', color: '#FF5722' },
                    { emoji: '🦎', name: 'Dino Growl', query: 'monster growl', color: '#795548' },
                    { emoji: '🐉', name: 'Dragon Roar', query: 'dragon roar', color: '#F44336' },
                    { emoji: '🦴', name: 'Bone Crunch', query: 'bone crack', color: '#ECEFF1' },
                    { emoji: '👣', name: 'Dino Steps', query: 'heavy footsteps', color: '#6D4C41' },
                    { emoji: '🌋', name: 'Volcano', query: 'volcano rumble', color: '#FF5722' },
                    { emoji: '🦷', name: 'Dino Bite', query: 'bite chomp', color: '#FFEB3B' },
                    { emoji: '🥚', name: 'Egg Crack', query: 'egg crack', color: '#FFF9C4' },
                    { emoji: '🌿', name: 'Jungle Stomp', query: 'stomp impact', color: '#2E7D32' },
                    { emoji: '💨', name: 'Dino Breath', query: 'monster breath', color: '#78909C' }
                ]
            }
        };

        // Sound cache and state
        const soundCache = {};
        const loadedSounds = {};
        let currentCategory = 'animals';
        let loopSettings = {
            count: -1, // -1 = infinite
            interval: 500,
            speed: 1.0
        };
        let activeSounds = {};
        let mixerSounds = [];

        // ============================================
        // FREESOUND API FUNCTIONS
        // ============================================
        async function searchFreesound(query) {
            const cacheKey = query.toLowerCase().replace(/\s+/g, '_');
            if (soundCache[cacheKey]) {
                return soundCache[cacheKey];
            }

            try {
                const response = await fetch(
                    `${FREESOUND_API_URL}/search/text/?query=${encodeURIComponent(query)}&token=${FREESOUND_API_KEY}&fields=id,name,previews&page_size=5&filter=duration:[0.1 TO 10]`
                );
                const data = await response.json();

                if (data.results && data.results.length > 0) {
                    const sound = data.results[0];
                    soundCache[cacheKey] = {
                        id: sound.id,
                        name: sound.name,
                        url: sound.previews['preview-hq-mp3']
                    };
                    return soundCache[cacheKey];
                }
            } catch (error) {
                console.error('Freesound API error:', error);
            }
            return null;
        }

        async function loadSound(soundInfo) {
            const cacheKey = soundInfo.query.toLowerCase().replace(/\s+/g, '_');

            if (loadedSounds[cacheKey]) {
                return loadedSounds[cacheKey];
            }

            const freesoundData = await searchFreesound(soundInfo.query);
            if (!freesoundData) return null;

            return new Promise((resolve) => {
                const howl = new Howl({
                    src: [freesoundData.url],
                    html5: true,
                    volume: 0.8,
                    rate: loopSettings.speed,
                    onload: () => {
                        loadedSounds[cacheKey] = howl;
                        resolve(howl);
                    },
                    onloaderror: () => {
                        console.error('Failed to load sound:', soundInfo.name);
                        resolve(null);
                    }
                });
            });
        }

        async function playSound(soundInfo, btn) {
            btn.classList.add('loading');

            try {
                let howl = await loadSound(soundInfo);
                if (!howl) {
                    showStatus('Sound not available');
                    btn.classList.remove('loading');
                    return;
                }

                btn.classList.remove('loading');
                btn.classList.add('playing');
                setTimeout(() => btn.classList.remove('playing'), 500);

                const cacheKey = soundInfo.query.toLowerCase().replace(/\s+/g, '_');

                // Stop existing sound if playing
                if (activeSounds[cacheKey]) {
                    clearInterval(activeSounds[cacheKey].interval);
                    activeSounds[cacheKey].howl.stop();
                    delete activeSounds[cacheKey];
                    btn.classList.remove('looping');
                    showStatus(`Stopped: ${soundInfo.name}`);
                    return;
                }

                howl.rate(loopSettings.speed);
                howl.play();

                if (loopMode) {
                    let playCount = 1;
                    const maxCount = loopSettings.count;

                    const intervalId = setInterval(() => {
                        if (maxCount !== -1 && playCount >= maxCount) {
                            clearInterval(intervalId);
                            delete activeSounds[cacheKey];
                            btn.classList.remove('looping');
                            showStatus(`Finished: ${soundInfo.name}`);
                            return;
                        }
                        howl.play();
                        playCount++;
                    }, loopSettings.interval);

                    activeSounds[cacheKey] = { howl, interval: intervalId, info: soundInfo };
                    btn.classList.add('looping');
                    showStatus(`Looping: ${soundInfo.name}`);
                } else {
                    showStatus(`Playing: ${soundInfo.name}`);
                }

                if (state.settings.confetti) spawnConfetti(3);

            } catch (error) {
                console.error('Error playing sound:', error);
                btn.classList.remove('loading');
                showStatus('Error playing sound');
            }
        }

        function stopAllSounds() {
            Object.keys(activeSounds).forEach(key => {
                clearInterval(activeSounds[key].interval);
                activeSounds[key].howl.stop();
            });
            activeSounds = {};
            document.querySelectorAll('.sound-btn.looping').forEach(btn => btn.classList.remove('looping'));

            // Stop mixer sounds too
            mixerSounds.forEach(ms => {
                if (ms.howl) ms.howl.stop();
            });

            showStatus('All sounds stopped');
        }

        // ============================================
        // LOOP SETTINGS
        // ============================================
        function openLoopSettings() {
            document.getElementById('loopModal').classList.add('show');
        }

        function closeLoopSettings() {
            document.getElementById('loopModal').classList.remove('show');
        }

        function setLoopCount(count, btn) {
            document.querySelectorAll('.loop-setting-options .loop-option').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            loopSettings.count = count;
        }

        function updateLoopInterval(value) {
            loopSettings.interval = parseInt(value);
            document.getElementById('loopIntervalValue').textContent = value + 'ms';
        }

        function updatePlaybackSpeed(value) {
            const speed = parseInt(value) / 100;
            loopSettings.speed = speed;
            document.getElementById('playbackSpeedValue').textContent = speed.toFixed(1) + '×';

            // Update all active sounds
            Object.values(loadedSounds).forEach(howl => {
                if (howl) howl.rate(speed);
            });
        }

        function saveLoopSettings() {
            closeLoopSettings();
            showStatus(`Loop: ${loopSettings.count === -1 ? '∞' : loopSettings.count + '×'} @ ${loopSettings.interval}ms`);
        }

        // ============================================
        // MIXER FUNCTIONS
        // ============================================
        function toggleMixer() {
            const mixer = document.getElementById('soundMixer');
            const btn = document.getElementById('mixerToggleBtn');
            const isVisible = mixer.style.display !== 'none';
            mixer.style.display = isVisible ? 'none' : 'block';
            btn.classList.toggle('active', !isVisible);
        }

        function addToMixer(soundInfo) {
            // Check if already in mixer
            if (mixerSounds.find(s => s.query === soundInfo.query)) {
                showStatus(`${soundInfo.name} already in mixer`);
                return;
            }

            mixerSounds.push({
                ...soundInfo,
                volume: 0.8,
                howl: null
            });

            renderMixer();
            showStatus(`Added ${soundInfo.name} to mixer`);

            // Show mixer if hidden
            document.getElementById('soundMixer').style.display = 'block';
            document.getElementById('mixerToggleBtn').classList.add('active');
        }

        function removeFromMixer(index) {
            if (mixerSounds[index].howl) {
                mixerSounds[index].howl.stop();
            }
            mixerSounds.splice(index, 1);
            renderMixer();
        }

        function updateMixerVolume(index, value) {
            mixerSounds[index].volume = parseFloat(value);
            if (mixerSounds[index].howl) {
                mixerSounds[index].howl.volume(mixerSounds[index].volume);
            }
        }

        async function playMixerSound(index) {
            const ms = mixerSounds[index];
            if (!ms.howl) {
                ms.howl = await loadSound(ms);
            }
            if (ms.howl) {
                ms.howl.volume(ms.volume);
                ms.howl.play();
            }
        }

        function stopMixerSound(index) {
            if (mixerSounds[index].howl) {
                mixerSounds[index].howl.stop();
            }
        }

        async function playAllMixer() {
            for (let i = 0; i < mixerSounds.length; i++) {
                await playMixerSound(i);
            }
            showStatus('Playing mixer sounds!');
        }

        function renderMixer() {
            const container = document.getElementById('mixerTracks');

            if (mixerSounds.length === 0) {
                container.innerHTML = '<div class="mixer-empty">Tap ➕ on any sound to add it here!</div>';
                return;
            }

            container.innerHTML = mixerSounds.map((ms, i) => `
                <div class="mixer-track">
                    <span class="mixer-track-emoji">${ms.emoji}</span>
                    <span class="mixer-track-name">${ms.name}</span>
                    <div class="mixer-track-controls">
                        <input type="range" class="mixer-volume" min="0" max="1" step="0.1" value="${ms.volume}" onchange="updateMixerVolume(${i}, this.value)">
                        <button class="mixer-btn play" onclick="playMixerSound(${i})">▶</button>
                        <button class="mixer-btn stop" onclick="stopMixerSound(${i})">⏹</button>
                        <button class="mixer-btn remove" onclick="removeFromMixer(${i})">✕</button>
                    </div>
                </div>
            `).join('');
        }

        // ============================================
        // SCENE MODES - Fun effect presets for all sounds
        // ============================================
        let currentSceneMode = 'normal';
        const sceneModes = {
            normal: { speed: 1.0, pitch: 0, echo: 0, filter: 20000 },
            underwater: { speed: 0.7, pitch: -3, echo: 60, filter: 800 },
            space: { speed: 0.5, pitch: 5, echo: 80, filter: 2000 },
            cave: { speed: 0.9, pitch: -2, echo: 90, filter: 1500 },
            fairy: { speed: 1.3, pitch: 7, echo: 30, filter: 10000 }
        };

        function setSceneMode(mode, btn) {
            currentSceneMode = mode;
            document.querySelectorAll('.scene-mode-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            const settings = sceneModes[mode];
            loopSettings.speed = settings.speed;

            // Update all loaded sounds
            Object.values(loadedSounds).forEach(howl => {
                if (howl) howl.rate(settings.speed);
            });

            showStatus(`Scene: ${mode.charAt(0).toUpperCase() + mode.slice(1)} mode!`);
            if (state.settings.confetti) spawnConfetti(5);
        }

        // ============================================
        // EDIT MODE & SOUND FX PANEL
        // ============================================
        let editMode = false;
        let currentEditSound = null;
        let currentEditHowl = null;
        let soundFxSettings = { pitch: 0, speed: 100, echo: 0, volume: 100 };

        function toggleEditMode() {
            editMode = !editMode;
            document.getElementById('editModeBtn').classList.toggle('active', editMode);
            showStatus(editMode ? '✏️ Edit Mode ON - Tap any sound to edit!' : '✏️ Edit Mode OFF');
        }

        function openFxPanel(soundInfo) {
            currentEditSound = soundInfo;
            document.getElementById('fxPanelEmoji').textContent = soundInfo.emoji;
            document.getElementById('fxPanelName').textContent = soundInfo.name;

            // Reset sliders
            soundFxSettings = { pitch: 0, speed: 100, echo: 0, volume: 100 };
            document.getElementById('fxPitchSlider').value = 0;
            document.getElementById('fxSpeedSlider').value = 100;
            document.getElementById('fxEchoSlider').value = 0;
            document.getElementById('fxVolumeSlider').value = 100;
            document.getElementById('fxPitchValue').textContent = '0';
            document.getElementById('fxSpeedValue').textContent = '1.0x';
            document.getElementById('fxEchoValue').textContent = '0%';
            document.getElementById('fxVolumeValue').textContent = '100%';

            // Check if favorite
            const isFav = favorites.some(f => f.query === soundInfo.query);
            document.getElementById('fxFavoriteBtn').classList.toggle('active', isFav);

            document.getElementById('soundFxPanel').classList.add('show');
        }

        function closeFxPanel() {
            document.getElementById('soundFxPanel').classList.remove('show');
            if (currentEditHowl) {
                currentEditHowl.stop();
                currentEditHowl = null;
            }
        }

        function updateFxPitch(value) {
            soundFxSettings.pitch = parseInt(value);
            document.getElementById('fxPitchValue').textContent = value > 0 ? `+${value}` : value;
        }

        function updateFxSpeed(value) {
            soundFxSettings.speed = parseInt(value);
            document.getElementById('fxSpeedValue').textContent = (value / 100).toFixed(1) + 'x';
            if (currentEditHowl) currentEditHowl.rate(value / 100);
        }

        function updateFxEcho(value) {
            soundFxSettings.echo = parseInt(value);
            document.getElementById('fxEchoValue').textContent = value + '%';
        }

        function updateFxVolume(value) {
            soundFxSettings.volume = parseInt(value);
            document.getElementById('fxVolumeValue').textContent = value + '%';
            if (currentEditHowl) currentEditHowl.volume(value / 100);
        }

        function applyQuickFx(effect) {
            const presets = {
                reverse: { pitch: 0, speed: 100, echo: 0, volume: 100, reverse: true },
                echo: { pitch: 0, speed: 100, echo: 80, volume: 100 },
                underwater: { pitch: -5, speed: 70, echo: 60, volume: 80 },
                space: { pitch: 8, speed: 50, echo: 90, volume: 100 },
                chipmunk: { pitch: 12, speed: 150, echo: 0, volume: 100 },
                monster: { pitch: -12, speed: 70, echo: 30, volume: 120 },
                robot: { pitch: -3, speed: 90, echo: 50, volume: 100 }
            };

            const preset = presets[effect];
            if (preset) {
                soundFxSettings = { ...preset };
                document.getElementById('fxPitchSlider').value = preset.pitch;
                document.getElementById('fxSpeedSlider').value = preset.speed;
                document.getElementById('fxEchoSlider').value = preset.echo;
                document.getElementById('fxVolumeSlider').value = preset.volume;
                updateFxPitch(preset.pitch);
                updateFxSpeed(preset.speed);
                updateFxEcho(preset.echo);
                updateFxVolume(preset.volume);
                showStatus(`Applied: ${effect}!`);
                playWithFx();
            }
        }

        async function playWithFx() {
            if (!currentEditSound) return;

            if (currentEditHowl) currentEditHowl.stop();

            currentEditHowl = await loadSound(currentEditSound);
            if (currentEditHowl) {
                // Apply pitch through rate (approximation)
                const pitchRate = Math.pow(2, soundFxSettings.pitch / 12);
                const speedRate = soundFxSettings.speed / 100;
                currentEditHowl.rate(pitchRate * speedRate);
                currentEditHowl.volume(soundFxSettings.volume / 100);
                currentEditHowl.play();
                showStatus(`Playing: ${currentEditSound.name}`);
            }
        }

        function stopCurrentFx() {
            if (currentEditHowl) {
                currentEditHowl.stop();
                showStatus('Stopped');
            }
        }

        function addToMixerWithFx() {
            if (!currentEditSound) return;

            const modifiedSound = {
                ...currentEditSound,
                name: `${currentEditSound.name} (edited)`,
                fx: { ...soundFxSettings }
            };

            mixerSounds.push({
                ...modifiedSound,
                volume: soundFxSettings.volume / 100,
                howl: null
            });

            renderMixer();
            showStatus(`Added edited ${currentEditSound.name} to mixer!`);
            document.getElementById('soundMixer').style.display = 'block';
            document.getElementById('mixerToggleBtn').classList.add('active');
            closeFxPanel();
        }

        // ============================================
        // FAVORITES SYSTEM
        // ============================================
        let favorites = JSON.parse(localStorage.getItem('juliaFavorites') || '[]');

        function toggleFavorite() {
            if (!currentEditSound) return;

            const idx = favorites.findIndex(f => f.query === currentEditSound.query);
            if (idx >= 0) {
                favorites.splice(idx, 1);
                document.getElementById('fxFavoriteBtn').classList.remove('active');
                showStatus('Removed from favorites');
            } else {
                favorites.push(currentEditSound);
                document.getElementById('fxFavoriteBtn').classList.add('active');
                showStatus('Added to favorites!');
                spawnConfetti(10);
            }

            localStorage.setItem('juliaFavorites', JSON.stringify(favorites));
            renderFavorites();
        }

        function addToFavorites(soundInfo) {
            if (favorites.some(f => f.query === soundInfo.query)) {
                showStatus('Already a favorite!');
                return;
            }
            favorites.push(soundInfo);
            localStorage.setItem('juliaFavorites', JSON.stringify(favorites));
            renderFavorites();
            showStatus('Added to favorites!');
            spawnConfetti(5);
        }

        function removeFromFavorites(index) {
            favorites.splice(index, 1);
            localStorage.setItem('juliaFavorites', JSON.stringify(favorites));
            renderFavorites();
            showStatus('Removed from favorites');
        }

        function renderFavorites() {
            const container = document.getElementById('favoritesGrid');
            if (favorites.length === 0) {
                container.innerHTML = '<span class="favorites-empty">Long-press any sound to add to favorites!</span>';
                return;
            }

            container.innerHTML = favorites.map((fav, i) => `
                <button class="favorite-sound" style="background: ${fav.color}"
                    onclick="playSound(favorites[${i}], this)"
                    title="${fav.name}">
                    ${fav.emoji}
                    <button class="remove-fav" onclick="event.stopPropagation(); removeFromFavorites(${i})">✕</button>
                </button>
            `).join('');
        }

        // ============================================
        // MINI SEQUENCER / BEAT MAKER
        // ============================================
        const SEQUENCER_STEPS = 8;
        let sequencerPattern = new Array(SEQUENCER_STEPS).fill(null);
        let sequencerPlaying = false;
        let sequencerInterval = null;
        let sequencerStep = 0;

        function initSequencer() {
            const container = document.getElementById('sequencerGrid');
            container.innerHTML = '';
            for (let i = 0; i < SEQUENCER_STEPS; i++) {
                const step = document.createElement('div');
                step.className = 'seq-step empty';
                step.dataset.step = i;
                step.onclick = () => selectSequencerStep(i);

                // Drop zone handling
                step.ondragover = (e) => {
                    e.preventDefault();
                    step.classList.add('drag-over');
                };
                step.ondragleave = () => {
                    step.classList.remove('drag-over');
                };
                step.ondrop = (e) => {
                    e.preventDefault();
                    step.classList.remove('drag-over');
                    const soundData = e.dataTransfer.getData('application/json');
                    if (soundData) {
                        const sound = JSON.parse(soundData);
                        sequencerPattern[i] = sound;
                        updateSequencerUI();
                        showStatus(`${sound.emoji} added to step ${i + 1}!`);
                    }
                };

                container.appendChild(step);
            }
        }

        // Drag & Drop handlers for sound buttons
        let draggedSound = null;
        let lastSelectedSound = null; // For tablet tap-to-add support

        function handleDragStart(e, soundIndex) {
            const sound = soundCategories[currentCategory].sounds[soundIndex];
            draggedSound = sound;
            lastSelectedSound = sound;
            e.target.classList.add('dragging');
            e.dataTransfer.setData('application/json', JSON.stringify(sound));
            e.dataTransfer.effectAllowed = 'copy';
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedSound = null;
            // Remove drag-over from all steps
            document.querySelectorAll('.seq-step').forEach(s => s.classList.remove('drag-over'));
        }

        function selectSequencerStep(stepIndex) {
            if (sequencerPattern[stepIndex]) {
                // Clear this step
                sequencerPattern[stepIndex] = null;
                updateSequencerUI();
                showStatus(`Step ${stepIndex + 1} cleared`);
                return;
            }

            // Use last selected/played sound if available, otherwise use random
            let soundToAdd = lastSelectedSound;

            if (!soundToAdd) {
                const category = soundCategories[currentCategory];
                if (!category || !category.sounds.length) return;
                const sounds = category.sounds;
                soundToAdd = sounds[Math.floor(Math.random() * sounds.length)];
            }

            sequencerPattern[stepIndex] = soundToAdd;
            updateSequencerUI();
            showStatus(`${soundToAdd.emoji} added to step ${stepIndex + 1}!`);
        }

        function updateSequencerUI() {
            const steps = document.querySelectorAll('.seq-step');
            steps.forEach((step, i) => {
                if (sequencerPattern[i]) {
                    step.classList.remove('empty');
                    step.classList.add('filled');
                    step.textContent = sequencerPattern[i].emoji;
                } else {
                    step.classList.add('empty');
                    step.classList.remove('filled');
                    step.textContent = '';
                }
            });
        }

        async function playSequence() {
            if (sequencerPlaying) return;

            const hasSound = sequencerPattern.some(s => s !== null);
            if (!hasSound) {
                showStatus('Add some sounds first!');
                return;
            }

            sequencerPlaying = true;
            sequencerStep = 0;
            showStatus('Playing sequence!');

            const steps = document.querySelectorAll('.seq-step');
            const tempo = 300; // ms per step

            sequencerInterval = setInterval(async () => {
                // Remove playing class from all
                steps.forEach(s => s.classList.remove('playing'));

                // Highlight current step
                steps[sequencerStep].classList.add('playing');

                // Play sound if exists
                const sound = sequencerPattern[sequencerStep];
                if (sound) {
                    const howl = await loadSound(sound);
                    if (howl) {
                        howl.rate(sceneModes[currentSceneMode].speed);
                        howl.play();
                    }
                }

                sequencerStep = (sequencerStep + 1) % SEQUENCER_STEPS;
            }, tempo);
        }

        function stopSequence() {
            sequencerPlaying = false;
            if (sequencerInterval) {
                clearInterval(sequencerInterval);
                sequencerInterval = null;
            }
            document.querySelectorAll('.seq-step').forEach(s => s.classList.remove('playing'));
            showStatus('Sequence stopped');
        }

        function clearSequence() {
            stopSequence();
            sequencerPattern = new Array(SEQUENCER_STEPS).fill(null);
            updateSequencerUI();
            showStatus('Sequence cleared');
        }

        // ============================================
        // UI RENDERING
        // ============================================
        function renderCategoryTabs() {
            const container = document.getElementById('categoryTabs');
            container.innerHTML = Object.keys(soundCategories).map(key => {
                const cat = soundCategories[key];
                return `<button class="category-tab ${key === currentCategory ? 'active' : ''}" onclick="switchCategory('${key}')">${cat.icon} ${cat.name.split(' ')[1]}</button>`;
            }).join('');
        }

        function switchCategory(categoryKey) {
            currentCategory = categoryKey;
            document.querySelectorAll('.category-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.category-tab[onclick="switchCategory('${categoryKey}')"]`).classList.add('active');
            renderSoundGrid();
        }

        function renderSoundGrid() {
            const container = document.getElementById('soundGrid');
            const category = soundCategories[currentCategory];

            container.innerHTML = category.sounds.map((sound, i) => `
                <button class="sound-btn" style="background: ${sound.color}" title="${sound.name} (drag to Beat Maker!)"
                    draggable="true"
                    onclick="handleSoundClick(${i}, this)"
                    oncontextmenu="event.preventDefault(); openFxPanel(soundCategories['${currentCategory}'].sounds[${i}])"
                    ondragstart="handleDragStart(event, ${i})"
                    ondragend="handleDragEnd(event)"
                    ontouchstart="handleTouchStart(event, ${i})"
                    ontouchend="handleTouchEnd(event, ${i})">
                    ${sound.emoji}
                </button>
            `).join('');
        }

        // Handle sound button click - play or edit depending on mode
        function handleSoundClick(index, btn) {
            const soundInfo = soundCategories[currentCategory].sounds[index];
            lastSelectedSound = soundInfo; // Track for Beat Maker tap-to-add
            if (editMode) {
                openFxPanel(soundInfo);
            } else {
                playSound(soundInfo, btn);
            }
        }

        // Long press for touch devices - opens FX panel for editing
        let touchTimer = null;
        let touchStartTime = 0;
        function handleTouchStart(event, index) {
            // Unlock audio on iOS/tablets immediately on touch
            initAudio();
            if (Howler.ctx && Howler.ctx.state === 'suspended') {
                Howler.ctx.resume();
            }
            touchStartTime = Date.now();
            touchTimer = setTimeout(() => {
                // Long press - open FX panel or add to favorites
                const soundInfo = soundCategories[currentCategory].sounds[index];
                openFxPanel(soundInfo);
                touchTimer = null;
            }, 500);
        }

        function handleTouchEnd(event, index) {
            if (touchTimer) {
                clearTimeout(touchTimer);
                touchTimer = null;
                // Short tap - play the sound
                // Unlock audio on iOS/tablets
                initAudio();
                if (Howler.ctx && Howler.ctx.state === 'suspended') {
                    Howler.ctx.resume();
                }
                const soundInfo = soundCategories[currentCategory].sounds[index];
                const btn = event.target.closest('.sound-btn');
                lastSelectedSound = soundInfo;
                if (editMode) {
                    openFxPanel(soundInfo);
                } else {
                    playSound(soundInfo, btn);
                }
                event.preventDefault();
            }
        }

        // State
        let audioContext = null;
        let analyser = null;
        let isAudioInitialized = false;
        let loopMode = false;
        let activeLoops = {};

        // Mic state
        let micStream = null;
        let micSource = null;
        let micContext = null;
        let micAnalyser = null;
        let mediaRecorder = null;
        let micChunks = [];
        let isMicRecording = false;
        let isMonitoring = false;
        let micAnimationFrame = null;

        // Audio nodes
        let micGainNode = null;
        let delayNode = null;
        let feedbackNode = null;
        let wetGainNode = null;
        let dryGainNode = null;
        let outputGainNode = null;
        let lowpassFilter = null;
        let highpassFilter = null;
        let distortionNode = null;
        let convolverNode = null;
        let oscillatorLFO = null;
        let lfoGain = null;
        let compressorNode = null;

        const micEffects = { pitch: 0, echo: 0, delay: 0, reverb: 0, gain: 1, currentEffect: 'normal' };

        const state = {
            instrument: 'piano',
            isRecording: false,
            recording: [],
            recordingStart: 0,
            currentTrack: null,
            settings: { volume: 80, effects: true, bubbles: true, confetti: true }
        };

        // NOTE: soundCategories is defined above (lines ~1533) with Freesound API queries
        // Do not redefine it here - that would overwrite the Freesound-enabled version!

        const drumPads = [
            { emoji: '🦶', name: 'Kick', color: '#E74C3C' },
            { emoji: '🥢', name: 'Snare', color: '#3498DB' },
            { emoji: '🎩', name: 'Hi-Hat', color: '#F1C40F' },
            { emoji: '💥', name: 'Crash', color: '#9B59B6' },
            { emoji: '🔈', name: 'Tom 1', color: '#2ECC71' },
            { emoji: '🔉', name: 'Tom 2', color: '#E67E22' },
            { emoji: '👏', name: 'Clap', color: '#1ABC9C' },
            { emoji: '🔊', name: 'Tom 3', color: '#FF6B9D' }
        ];

        // New instrument configurations
        const guitarNotes = ['E2', 'A2', 'D3', 'G3', 'B3', 'E4'];
        const guitarColors = ['#8B4513', '#A0522D', '#CD853F', '#DEB887', '#D2B48C', '#F5DEB3'];

        const bellNotes = ['C5', 'D5', 'E5', 'F5', 'G5', 'A5', 'B5', 'C6'];
        const bellColors = ['#FFD700', '#FFC107', '#FFB300', '#FFA000', '#FF8F00', '#FF6F00', '#F57C00', '#EF6C00'];

        const bassNotes = ['E1', 'A1', 'D2', 'G2', 'C2', 'F2'];
        const bassColors = ['#1a237e', '#283593', '#303f9f', '#3949ab', '#3f51b5', '#5c6bc0'];

        const synthNotes = ['C3', 'E3', 'G3', 'C4', 'E4', 'G4', 'C5', 'E5'];
        const synthColors = ['#00BCD4', '#00ACC1', '#0097A7', '#00838F', '#006064', '#004D40', '#00695C', '#00796B'];

        // Harp - 12 strings with golden gradient
        const harpNotes = ['C3', 'D3', 'E3', 'F3', 'G3', 'A3', 'B3', 'C4', 'D4', 'E4', 'F4', 'G4'];
        const harpColors = ['#DAA520', '#D4AF37', '#CFB53B', '#C9A227', '#B8860B', '#CD853F', '#DAA520', '#D4AF37', '#CFB53B', '#C9A227', '#B8860B', '#CD853F'];

        // Kalimba - African thumb piano, 9 tines
        const kalimbaNotes = ['C4', 'D4', 'E4', 'G4', 'A4', 'C5', 'D5', 'E5', 'G5'];
        const kalimbaHeights = [90, 100, 110, 120, 130, 120, 110, 100, 90];
        const kalimbaColors = ['#8B4513', '#A0522D', '#8B4513', '#A0522D', '#8B4513', '#A0522D', '#8B4513', '#A0522D', '#8B4513'];

        // Steel Drums - Caribbean vibes, 8 sections
        const steelDrumNotes = ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'C5'];
        const steelDrumColors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F'];

        // Organ - church/cathedral organ
        const organNotes = ['C3', 'D3', 'E3', 'F3', 'G3', 'A3', 'B3', 'C4', 'D4', 'E4'];
        const organColors = ['#4A4A4A', '#5A5A5A', '#4A4A4A', '#5A5A5A', '#4A4A4A', '#5A5A5A', '#4A4A4A', '#5A5A5A', '#4A4A4A', '#5A5A5A'];

        // Marimba - deeper wooden xylophone
        const marimbaNotes = ['C3', 'D3', 'E3', 'F3', 'G3', 'A3', 'B3', 'C4'];
        const marimbaHeights = [140, 130, 120, 115, 110, 105, 100, 95];
        const marimbaColors = ['#D2691E', '#CD853F', '#DEB887', '#F4A460', '#D2691E', '#CD853F', '#DEB887', '#F4A460'];

        // Flute - breathy wind instrument
        const fluteNotes = ['D4', 'E4', 'F#4', 'G4', 'A4', 'B4', 'C#5', 'D5'];
        const fluteColors = ['#C0C0C0', '#D3D3D3', '#C0C0C0', '#D3D3D3', '#C0C0C0', '#D3D3D3', '#C0C0C0', '#D3D3D3'];

        // Music Box - delicate mechanical sound
        const chimesNotes = ['E5', 'G5', 'A5', 'B5', 'C6', 'D6', 'E6', 'G6'];
        const chimesColors = ['#FFB6C1', '#FFC0CB', '#FFD1DC', '#FFE4E1', '#FFF0F5', '#FFE4E1', '#FFD1DC', '#FFC0CB'];

        // Trumpet - brass, bold
        const trumpetNotes = ['C4', 'E4', 'G4', 'C5', 'E5', 'G5'];
        const trumpetColors = ['#FFD700', '#FFC107', '#FFB300', '#FFA000', '#FF8F00', '#FF6F00'];

        const tracks = [
            // Classic Kids Songs
            { name: '⭐ Twinkle Twinkle', tempo: 90, pattern: 'twinkle' },
            { name: '🐑 Mary Had a Lamb', tempo: 100, pattern: 'mary' },
            { name: '🎂 Happy Birthday', tempo: 110, pattern: 'birthday' },
            { name: '🔔 Jingle Bells', tempo: 120, pattern: 'jingle' },
            { name: '🎵 Ode to Joy', tempo: 100, pattern: 'odeToJoy' },
            { name: '🥖 Hot Cross Buns', tempo: 90, pattern: 'hotCross' },
            { name: '🌉 London Bridge', tempo: 110, pattern: 'london' },
            { name: '🚣 Row Your Boat', tempo: 80, pattern: 'rowBoat' },
            { name: '🐸 Baby Shark', tempo: 115, pattern: 'babyShark' },
            { name: '🌈 Somewhere Rainbow', tempo: 75, pattern: 'rainbow' },
            { name: '🎹 Für Elise', tempo: 85, pattern: 'furElise' },
            { name: '🏴‍☠️ Pirates Theme', tempo: 130, pattern: 'pirates' },
            // Beat Tracks
            { name: '🎸 Rock Beat', tempo: 120, pattern: 'rock' },
            { name: '🎹 Jazz', tempo: 90, pattern: 'jazz' },
            { name: '🎉 Party', tempo: 140, pattern: 'party' },
            { name: '🌙 Lullaby', tempo: 70, pattern: 'lullaby' }
        ];

        const pianoNotes = ['C4', 'C#4', 'D4', 'D#4', 'E4', 'F4', 'F#4', 'G4', 'G#4', 'A4', 'A#4', 'B4', 'C5'];
        const pianoKeys = ['a', 'w', 's', 'e', 'd', 'f', 't', 'g', 'y', 'h', 'u', 'j', 'k'];
        const xyloNotes = ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'C5'];
        const xyloColors = ['#E74C3C', '#E67E22', '#F1C40F', '#2ECC71', '#1ABC9C', '#3498DB', '#9B59B6', '#FF6B9D'];

        // Audio Init
        async function initAudio() {
            if (isAudioInitialized) return;
            try {
                await Tone.start();
                audioContext = Tone.context.rawContext;
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                Tone.getDestination().connect(analyser);
                isAudioInitialized = true;
            } catch (e) { console.error('Audio init failed:', e); }
        }

        document.addEventListener('click', initAudio, { once: true });
        document.addEventListener('touchstart', initAudio, { once: true });

        // Synths
        const synths = {
            piano: new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'triangle' }, envelope: { attack: 0.02, decay: 0.3, sustain: 0.2, release: 1 } }).toDestination(),
            xylophone: new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 0.5, sustain: 0, release: 0.5 } }).toDestination(),
            guitar: new Tone.PluckSynth({ attackNoise: 1, dampening: 4000, resonance: 0.98 }).toDestination(),
            bells: new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 1.5, sustain: 0, release: 1.5 } }).toDestination(),
            bass: new Tone.MonoSynth({ oscillator: { type: 'sawtooth' }, envelope: { attack: 0.05, decay: 0.3, sustain: 0.4, release: 0.8 }, filterEnvelope: { attack: 0.05, decay: 0.2, sustain: 0.5, release: 0.8, baseFrequency: 200, octaves: 2.5 } }).toDestination(),
            synthPad: new Tone.PolySynth(Tone.FMSynth, { harmonicity: 3, modulationIndex: 10, envelope: { attack: 0.2, decay: 0.3, sustain: 0.8, release: 1.5 } }).toDestination(),
            // New creative instruments
            harp: new Tone.PluckSynth({ attackNoise: 0.5, dampening: 2000, resonance: 0.99 }).toDestination(),
            kalimba: new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 2, sustain: 0, release: 2 } }).toDestination(),
            steelDrum: new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'triangle' }, envelope: { attack: 0.01, decay: 0.8, sustain: 0.1, release: 1 } }).toDestination(),
            organ: new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'square' }, envelope: { attack: 0.05, decay: 0.1, sustain: 0.9, release: 0.5 } }).toDestination(),
            marimba: new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 1, sustain: 0, release: 1 } }).toDestination(),
            flute: new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'sine' }, envelope: { attack: 0.1, decay: 0.1, sustain: 0.8, release: 0.3 } }).toDestination(),
            chimes: new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 3, sustain: 0, release: 3 } }).toDestination(),
            trumpet: new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'sawtooth' }, envelope: { attack: 0.05, decay: 0.2, sustain: 0.8, release: 0.3 } }).toDestination(),
            drums: {
                kick: new Tone.MembraneSynth().toDestination(),
                snare: new Tone.NoiseSynth({ noise: { type: 'white' }, envelope: { attack: 0.005, decay: 0.2, sustain: 0 } }).toDestination(),
                hihat: new Tone.MetalSynth({ frequency: 200, envelope: { attack: 0.001, decay: 0.1, release: 0.01 }, harmonicity: 5.1, modulationIndex: 32, resonance: 4000, octaves: 1.5 }).toDestination(),
                tom: new Tone.MembraneSynth({ pitchDecay: 0.05, octaves: 4 }).toDestination(),
                clap: new Tone.NoiseSynth({ noise: { type: 'pink' }, envelope: { attack: 0.005, decay: 0.15, sustain: 0 } }).toDestination()
            },
            fx: {
                sine: new Tone.Synth({ oscillator: { type: 'sine' } }).toDestination(),
                saw: new Tone.Synth({ oscillator: { type: 'sawtooth' } }).toDestination(),
                square: new Tone.Synth({ oscillator: { type: 'square' } }).toDestination(),
                noise: new Tone.NoiseSynth({ noise: { type: 'brown' } }).toDestination(),
                whiteNoise: new Tone.NoiseSynth({ noise: { type: 'white' } }).toDestination(),
                metal: new Tone.MetalSynth().toDestination(),
                membrane: new Tone.MembraneSynth().toDestination(),
                poly: new Tone.PolySynth().toDestination(),
                pluck: new Tone.PluckSynth().toDestination(),
                fm: new Tone.FMSynth().toDestination()
            }
        };

        // Sound effect functions - SYNTHESIZED sounds (not recordings!)
        const effectFns = {
            // Animals - these are synth approximations, not real recordings
            cat: () => {
                // Meow: descending pitch
                synths.fx.saw.triggerAttackRelease('A5', '0.25');
                setTimeout(() => synths.fx.saw.triggerAttackRelease('F5', '0.2'), 120);
                setTimeout(() => synths.fx.saw.triggerAttackRelease('D5', '0.3'), 220);
            },
            dog: () => {
                // Bark: short bursts
                synths.fx.square.triggerAttackRelease('G3', '0.1');
                setTimeout(() => synths.fx.square.triggerAttackRelease('B3', '0.15'), 80);
            },
            frog: () => {
                // Ribbit: two low tones
                synths.fx.sine.triggerAttackRelease('G2', '0.15');
                setTimeout(() => synths.fx.sine.triggerAttackRelease('G2', '0.2'), 150);
            },
            lion: () => {
                // Roar: loud noise burst + low rumble
                synths.fx.noise.triggerAttackRelease('0.8');
                synths.fx.membrane.triggerAttackRelease('E1', '0.8');
            },
            bird: () => {
                // Chirp: high ascending notes
                synths.fx.sine.triggerAttackRelease('E6', '0.08');
                setTimeout(() => synths.fx.sine.triggerAttackRelease('G6', '0.08'), 80);
                setTimeout(() => synths.fx.sine.triggerAttackRelease('B6', '0.1'), 160);
                setTimeout(() => synths.fx.sine.triggerAttackRelease('E7', '0.12'), 240);
            },
            cow: () => {
                // Moo: long low tone
                synths.fx.saw.triggerAttackRelease('G2', '1.0');
                setTimeout(() => synths.fx.saw.triggerAttackRelease('E2', '0.8'), 400);
            },
            pig: () => {
                // Oink: nasal sound
                synths.fx.square.triggerAttackRelease('E4', '0.1');
                setTimeout(() => synths.fx.square.triggerAttackRelease('G4', '0.15'), 80);
                setTimeout(() => synths.fx.square.triggerAttackRelease('E4', '0.1'), 180);
            },
            horse: () => {
                // Neigh: rising then falling
                synths.fx.saw.triggerAttackRelease('E4', '0.2');
                setTimeout(() => synths.fx.saw.triggerAttackRelease('A4', '0.25'), 150);
                setTimeout(() => synths.fx.saw.triggerAttackRelease('E5', '0.3'), 300);
                setTimeout(() => synths.fx.saw.triggerAttackRelease('A4', '0.4'), 500);
            },
            duck: () => {
                // Quack: nasal honk
                synths.fx.square.triggerAttackRelease('D4', '0.12');
                setTimeout(() => synths.fx.square.triggerAttackRelease('F4', '0.15'), 100);
            },
            bee: () => {
                // Buzz: continuous buzzing
                synths.fx.saw.triggerAttackRelease('A3', '0.5');
                synths.fx.saw.triggerAttackRelease('A#3', '0.5');
            },
            owl: () => {
                // Hoot: two low tones
                synths.fx.sine.triggerAttackRelease('E3', '0.5');
                setTimeout(() => synths.fx.sine.triggerAttackRelease('C3', '0.6'), 500);
            },
            wolf: () => {
                // Howl: rising tone
                synths.fx.saw.triggerAttackRelease('D3', '0.4');
                setTimeout(() => synths.fx.saw.triggerAttackRelease('G3', '0.5'), 300);
                setTimeout(() => synths.fx.saw.triggerAttackRelease('D4', '0.7'), 600);
            },
            fox: () => {
                // Yip: short high bark
                synths.fx.square.triggerAttackRelease('A4', '0.1');
                setTimeout(() => synths.fx.square.triggerAttackRelease('E5', '0.12'), 80);
            },
            elephant: () => {
                // Trumpet: loud brass-like
                synths.fx.membrane.triggerAttackRelease('C2', '0.8');
                synths.fx.fm.triggerAttackRelease('C3', '0.6');
            },
            monkey: () => {
                // Screech: fast high notes
                synths.fx.sine.triggerAttackRelease('C5', '0.08');
                setTimeout(() => synths.fx.sine.triggerAttackRelease('G5', '0.08'), 60);
                setTimeout(() => synths.fx.sine.triggerAttackRelease('E6', '0.1'), 120);
                setTimeout(() => synths.fx.sine.triggerAttackRelease('G5', '0.08'), 180);
                setTimeout(() => synths.fx.sine.triggerAttackRelease('C6', '0.12'), 240);
            },
            trumpet: () => synths.fx.square.triggerAttackRelease('C4', '0.5'),
            bell: () => synths.fx.metal.triggerAttackRelease('C5', '0.5'),
            sax: () => synths.fx.fm.triggerAttackRelease('G3', '0.4'),
            violin: () => { synths.fx.saw.triggerAttackRelease('A4', '0.3'); setTimeout(() => synths.fx.saw.triggerAttackRelease('E5', '0.3'), 150); },
            banjo: () => synths.fx.pluck.triggerAttack('G3'),
            guitar: () => synths.fx.pluck.triggerAttack('E3'),
            flute: () => synths.fx.sine.triggerAttackRelease('C5', '0.4'),
            fanfare: () => { synths.fx.square.triggerAttackRelease('C4', '0.2'); setTimeout(() => synths.fx.square.triggerAttackRelease('E4', '0.2'), 150); setTimeout(() => synths.fx.square.triggerAttackRelease('G4', '0.3'), 300); },
            boom: () => synths.fx.membrane.triggerAttackRelease('C1', '0.5'),
            magic: () => synths.fx.poly.triggerAttackRelease(['C5', 'E5', 'G5', 'B5'], '0.5'),
            car: () => { synths.fx.saw.triggerAttackRelease('E2', '0.3'); setTimeout(() => synths.fx.saw.triggerAttackRelease('G2', '0.3'), 200); },
            rocket: () => synths.fx.whiteNoise.triggerAttackRelease('0.8'),
            zap: () => { synths.fx.fm.triggerAttackRelease('C6', '0.1'); setTimeout(() => synths.fx.fm.triggerAttackRelease('G5', '0.15'), 50); },
            wind: () => synths.fx.noise.triggerAttackRelease('0.6'),
            wave: () => { synths.fx.sine.triggerAttackRelease('C3', '0.4'); setTimeout(() => synths.fx.sine.triggerAttackRelease('E3', '0.4'), 200); },
            fire: () => synths.fx.whiteNoise.triggerAttackRelease('0.4'),
            ghost: () => { synths.fx.sine.triggerAttackRelease('E3', '0.5'); setTimeout(() => synths.fx.sine.triggerAttackRelease('G3', '0.4'), 250); },
            robot: () => { synths.fx.square.triggerAttackRelease('C3', '0.1'); setTimeout(() => synths.fx.square.triggerAttackRelease('G3', '0.1'), 100); setTimeout(() => synths.fx.square.triggerAttackRelease('C4', '0.15'), 200); },
            alien: () => { synths.fx.fm.triggerAttackRelease('G4', '0.3'); setTimeout(() => synths.fx.fm.triggerAttackRelease('C5', '0.2'), 150); },
            pumpkin: () => { synths.fx.sine.triggerAttackRelease('D3', '0.4'); setTimeout(() => synths.fx.sine.triggerAttackRelease('F3', '0.4'), 200); },
            pop: () => synths.fx.membrane.triggerAttackRelease('G4', '0.1'),
            twinkle: () => { synths.fx.sine.triggerAttackRelease('C6', '0.15'); setTimeout(() => synths.fx.sine.triggerAttackRelease('E6', '0.1'), 100); },
            shine: () => synths.fx.poly.triggerAttackRelease(['C5', 'G5', 'C6'], '0.3'),
            ice: () => synths.fx.metal.triggerAttackRelease('E6', '0.3'),
            ding: () => synths.fx.sine.triggerAttackRelease('C5', '0.2'),
            jingle: () => { synths.fx.sine.triggerAttackRelease('C5', '0.15'); setTimeout(() => synths.fx.sine.triggerAttackRelease('E5', '0.15'), 100); setTimeout(() => synths.fx.sine.triggerAttackRelease('G5', '0.15'), 200); },
            drumroll: () => { for(let i = 0; i < 8; i++) { setTimeout(() => synths.drums.snare.triggerAttackRelease('16n'), i * 60); } }
        };

        // Loop mode (updated for Freesound)
        function toggleLoopMode() {
            loopMode = !loopMode;
            document.getElementById('loopModeBtn').classList.toggle('active', loopMode);
            showStatus(loopMode ? '🔁 Loop Mode ON' : '🔁 Loop Mode OFF');
        }

        // Legacy playEffect for fallback (uses Tone.js synths)
        function playEffect(name, btn) {
            initAudio();

            if (loopMode) {
                if (activeLoops[name]) {
                    clearInterval(activeLoops[name]);
                    delete activeLoops[name];
                    btn.classList.remove('looping');
                    showStatus(`Stopped: ${name}`);
                } else {
                    if (effectFns[name]) effectFns[name]();
                    activeLoops[name] = setInterval(() => { if (effectFns[name]) effectFns[name](); }, 500);
                    btn.classList.add('looping');
                    showStatus(`Looping: ${name}`);
                }
            } else {
                if (effectFns[name]) effectFns[name]();
                animateBtn(btn);
                if (state.settings.confetti) spawnConfetti(3);
            }
            recordEvent('effect', name);
        }

        let currentLoop = null;

        function createLoop(pattern, tempo) {
            Tone.Transport.bpm.value = tempo;
            if (currentLoop) { currentLoop.stop(); currentLoop.dispose(); }

            const patterns = {
                // Classic Kids Songs
                twinkle: () => new Tone.Sequence((t, n) => synths.xylophone.triggerAttackRelease(n, '4n', t),
                    ['C4', 'C4', 'G4', 'G4', 'A4', 'A4', 'G4', null, 'F4', 'F4', 'E4', 'E4', 'D4', 'D4', 'C4', null], '4n'),
                mary: () => new Tone.Sequence((t, n) => synths.xylophone.triggerAttackRelease(n, '4n', t),
                    ['E4', 'D4', 'C4', 'D4', 'E4', 'E4', 'E4', null, 'D4', 'D4', 'D4', null, 'E4', 'G4', 'G4', null], '4n'),
                birthday: () => new Tone.Sequence((t, n) => synths.piano.triggerAttackRelease(n, '4n', t),
                    ['C4', 'C4', 'D4', 'C4', 'F4', 'E4', null, 'C4', 'C4', 'D4', 'C4', 'G4', 'F4', null, null, null], '4n'),
                jingle: () => new Tone.Sequence((t, n) => synths.bells.triggerAttackRelease(n, '4n', t),
                    ['E4', 'E4', 'E4', null, 'E4', 'E4', 'E4', null, 'E4', 'G4', 'C4', 'D4', 'E4', null, null, null], '4n'),
                odeToJoy: () => new Tone.Sequence((t, n) => synths.piano.triggerAttackRelease(n, '4n', t),
                    ['E4', 'E4', 'F4', 'G4', 'G4', 'F4', 'E4', 'D4', 'C4', 'C4', 'D4', 'E4', 'E4', 'D4', 'D4', null], '4n'),
                hotCross: () => new Tone.Sequence((t, n) => synths.xylophone.triggerAttackRelease(n, '4n', t),
                    ['E4', 'D4', 'C4', null, 'E4', 'D4', 'C4', null, 'C4', 'C4', 'C4', 'C4', 'D4', 'D4', 'D4', 'D4', 'E4', 'D4', 'C4', null], '4n'),
                london: () => new Tone.Sequence((t, n) => synths.xylophone.triggerAttackRelease(n, '4n', t),
                    ['G4', 'A4', 'G4', 'F4', 'E4', 'F4', 'G4', null, 'D4', 'E4', 'F4', null, 'E4', 'F4', 'G4', null], '4n'),
                rowBoat: () => new Tone.Sequence((t, n) => synths.piano.triggerAttackRelease(n, '4n', t, 0.6),
                    ['C4', 'C4', 'C4', 'D4', 'E4', null, 'E4', 'D4', 'E4', 'F4', 'G4', null, null, null, null, null], '4n'),
                babyShark: () => new Tone.Sequence((t, n) => synths.xylophone.triggerAttackRelease(n, '8n', t),
                    ['C4', 'D4', 'F4', 'F4', 'F4', 'F4', 'F4', 'F4', 'C4', 'D4', 'F4', 'F4', 'F4', 'F4', 'F4', 'F4'], '8n'),
                rainbow: () => new Tone.Sequence((t, n) => synths.piano.triggerAttackRelease(n, '2n', t, 0.5),
                    ['C4', 'C5', 'B4', 'G4', 'A4', 'B4', 'C5', null], '2n'),
                furElise: () => new Tone.Sequence((t, n) => synths.piano.triggerAttackRelease(n, '8n', t, 0.6),
                    ['E5', 'D#5', 'E5', 'D#5', 'E5', 'B4', 'D5', 'C5', 'A4', null, 'C4', 'E4', 'A4', 'B4', null, 'E4', 'G#4', 'B4', 'C5', null, null, null, null, null], '8n'),
                pirates: () => new Tone.Sequence((t, n) => synths.organ.triggerAttackRelease(n, '8n', t, 0.7),
                    ['D4', 'D4', 'D4', 'D4', 'D4', 'D4', 'D4', 'D4', 'A#3', 'A#3', 'C4', 'D4', 'D4', 'D4', 'E4', 'F4', 'F4', 'F4', 'G4', 'E4', 'E4', 'D4', 'C4', 'D4'], '8n'),
                // Beat Tracks
                rock: () => new Tone.Sequence((t, n) => { if (n === 'k') synths.drums.kick.triggerAttackRelease('C2', '8n', t); if (n === 's') synths.drums.snare.triggerAttackRelease('8n', t); if (n === 'h') synths.drums.hihat.triggerAttackRelease('C5', '16n', t, 0.3); }, ['k', 'h', 's', 'h', 'k', 'h', 's', 'h'], '8n'),
                jazz: () => new Tone.Sequence((t, n) => synths.piano.triggerAttackRelease(n, '8n', t, 0.5), ['C3', 'E3', 'G3', 'B3', 'C4', 'B3', 'G3', 'E3'], '8n'),
                lullaby: () => new Tone.Sequence((t, n) => synths.piano.triggerAttackRelease(n, '4n', t, 0.3), ['C4', 'E4', 'G4', 'E4'], '4n'),
                party: () => new Tone.Sequence((t, n) => { if (n === 'k') synths.drums.kick.triggerAttackRelease('C2', '8n', t); if (n === 's') synths.drums.snare.triggerAttackRelease('8n', t); if (n === 'h') synths.drums.hihat.triggerAttackRelease('C5', '16n', t, 0.5); if (n === 't') synths.drums.tom.triggerAttackRelease('G2', '8n', t); }, ['k', 'h', 'h', 's', 'k', 'k', 'h', 's', 'h', 't', 'h', 's'], '8n')
            };

            currentLoop = patterns[pattern]();
            return currentLoop;
        }

        // Microphone functions
        function makeDistortionCurve(amount) {
            const k = typeof amount === 'number' ? amount : 50;
            const n_samples = 44100;
            const curve = new Float32Array(n_samples);
            const deg = Math.PI / 180;
            for (let i = 0; i < n_samples; ++i) {
                const x = i * 2 / n_samples - 1;
                curve[i] = (3 + k) * x * 20 * deg / (Math.PI + k * Math.abs(x));
            }
            return curve;
        }

        function createImpulseResponse(duration, decay) {
            const sampleRate = micContext.sampleRate;
            const length = sampleRate * duration;
            const impulse = micContext.createBuffer(2, length, sampleRate);
            const left = impulse.getChannelData(0);
            const right = impulse.getChannelData(1);
            for (let i = 0; i < length; i++) {
                const n = i / length;
                left[i] = (Math.random() * 2 - 1) * Math.pow(1 - n, decay);
                right[i] = (Math.random() * 2 - 1) * Math.pow(1 - n, decay);
            }
            return impulse;
        }

        async function connectMicrophone() {
            try {
                // Get microphone stream
                micStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    }
                });

                // Create audio context
                micContext = new (window.AudioContext || window.webkitAudioContext)();

                // Resume context (required for some browsers)
                if (micContext.state === 'suspended') {
                    await micContext.resume();
                }

                micSource = micContext.createMediaStreamSource(micStream);
                micAnalyser = micContext.createAnalyser();
                micAnalyser.fftSize = 256;

                micGainNode = micContext.createGain();
                micGainNode.gain.value = micEffects.gain;

                lowpassFilter = micContext.createBiquadFilter();
                lowpassFilter.type = 'lowpass';
                lowpassFilter.frequency.value = 20000;

                highpassFilter = micContext.createBiquadFilter();
                highpassFilter.type = 'highpass';
                highpassFilter.frequency.value = 20;

                distortionNode = micContext.createWaveShaper();
                distortionNode.curve = makeDistortionCurve(0);
                distortionNode.oversample = '4x';

                compressorNode = micContext.createDynamicsCompressor();
                compressorNode.threshold.value = -24;
                compressorNode.knee.value = 30;
                compressorNode.ratio.value = 12;

                convolverNode = micContext.createConvolver();
                convolverNode.buffer = createImpulseResponse(2, 2);

                oscillatorLFO = micContext.createOscillator();
                oscillatorLFO.type = 'sine';
                oscillatorLFO.frequency.value = 5;
                lfoGain = micContext.createGain();
                lfoGain.gain.value = 0;
                oscillatorLFO.connect(lfoGain);
                oscillatorLFO.start();

                delayNode = micContext.createDelay(1.0);
                delayNode.delayTime.value = micEffects.delay / 1000;

                feedbackNode = micContext.createGain();
                feedbackNode.gain.value = micEffects.echo / 100 * 0.7;

                dryGainNode = micContext.createGain();
                dryGainNode.gain.value = 1.0;

                wetGainNode = micContext.createGain();
                wetGainNode.gain.value = 0.3;

                const reverbGain = micContext.createGain();
                reverbGain.gain.value = 0;
                window.reverbGainNode = reverbGain;

                outputGainNode = micContext.createGain();
                outputGainNode.gain.value = 0;

                micSource.connect(micAnalyser);
                micSource.connect(micGainNode);
                micGainNode.connect(highpassFilter);
                highpassFilter.connect(lowpassFilter);
                lowpassFilter.connect(distortionNode);
                distortionNode.connect(compressorNode);

                lfoGain.connect(outputGainNode.gain);

                compressorNode.connect(dryGainNode);
                dryGainNode.connect(outputGainNode);

                compressorNode.connect(delayNode);
                delayNode.connect(wetGainNode);
                wetGainNode.connect(outputGainNode);

                delayNode.connect(feedbackNode);
                feedbackNode.connect(delayNode);

                compressorNode.connect(convolverNode);
                convolverNode.connect(reverbGain);
                reverbGain.connect(outputGainNode);

                outputGainNode.connect(micContext.destination);

                document.getElementById('micDot').classList.add('ready');
                document.getElementById('micStatus').textContent = 'Connected';
                document.getElementById('micConnectBtn').disabled = true;
                document.getElementById('micRecordBtn').disabled = false;
                document.getElementById('micStopBtn').disabled = false;

                updateMicLevel();
                showStatus('Microphone connected!');
            } catch (err) {
                console.error('Mic error:', err);

                // Give specific error messages
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    showStatus('⚠️ Mic permission denied');
                    alert('Microphone permission was denied.\n\n1. Tap the 🔒 icon in your browser address bar\n2. Allow microphone access\n3. Refresh the page and try again');
                } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                    showStatus('⚠️ No microphone found');
                    alert('No microphone found on this device.');
                } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
                    showStatus('⚠️ Mic in use');
                    alert('Microphone is being used by another app.\n\nClose other apps using the mic and try again.');
                } else {
                    showStatus('⚠️ Mic error');
                    alert('Could not access microphone.\n\nError: ' + err.message);
                }

                // Clean up if context was created
                if (micContext) {
                    micContext.close();
                    micContext = null;
                }
            }
        }

        function toggleMonitor() {
            if (!micStream) { showStatus('Connect microphone first!'); return; }
            if (micContext && micContext.state === 'suspended') micContext.resume();

            isMonitoring = !isMonitoring;
            const toggle = document.getElementById('monitorSwitch');
            const dot = document.getElementById('micDot');

            if (isMonitoring) {
                if (outputGainNode) outputGainNode.gain.setValueAtTime(1.0, micContext.currentTime);
                toggle.classList.add('on');
                dot.classList.add('monitoring');
                document.getElementById('micStatus').textContent = 'Monitoring ON';
                showStatus('Use headphones!');
            } else {
                if (outputGainNode) outputGainNode.gain.setValueAtTime(0, micContext.currentTime);
                toggle.classList.remove('on');
                dot.classList.remove('monitoring');
                document.getElementById('micStatus').textContent = 'Connected';
            }
        }

        function setVoiceEffect(effect, btn) {
            micEffects.currentEffect = effect;
            document.querySelectorAll('.effect-chip').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');

            const presets = {
                normal: { pitch: 0, echo: 0, delay: 0, reverb: 0 },
                robot: { pitch: -5, echo: 30, delay: 50, reverb: 20 },
                chipmunk: { pitch: 12, echo: 0, delay: 0, reverb: 10 },
                monster: { pitch: -12, echo: 20, delay: 100, reverb: 30 },
                echo: { pitch: 0, echo: 60, delay: 200, reverb: 40 },
                alien: { pitch: 7, echo: 40, delay: 150, reverb: 50 }
            };

            const preset = presets[effect];
            if (preset) {
                document.getElementById('pitchSlider').value = preset.pitch;
                document.getElementById('echoSlider').value = preset.echo;
                document.getElementById('delaySlider').value = preset.delay;
                document.getElementById('reverbSlider').value = preset.reverb;
                updatePitch(preset.pitch);
                updateEcho(preset.echo);
                updateDelay(preset.delay);
                updateReverb(preset.reverb);
            }
            showStatus(`Voice: ${effect}`);
        }

        function updatePitch(value) { micEffects.pitch = parseInt(value); document.getElementById('pitchValue').textContent = value > 0 ? `+${value}` : value; }
        function updateEcho(value) { micEffects.echo = parseInt(value); document.getElementById('echoValue').textContent = value + '%'; if (feedbackNode) feedbackNode.gain.value = value / 100 * 0.7; if (wetGainNode && dryGainNode) { const wetAmount = Math.min(value / 100, 0.8); wetGainNode.gain.value = wetAmount; dryGainNode.gain.value = 1.0 - (wetAmount * 0.3); } }
        function updateDelay(value) { micEffects.delay = parseInt(value); document.getElementById('delayValue').textContent = value + 'ms'; if (delayNode) delayNode.delayTime.value = value / 1000; }
        function updateReverb(value) { micEffects.reverb = parseInt(value); document.getElementById('reverbValue').textContent = value + '%'; }
        function updateGain(value) { micEffects.gain = value / 100; document.getElementById('gainValue').textContent = value + '%'; if (micGainNode) micGainNode.gain.value = micEffects.gain; }

        function updateMicLevel() {
            if (!micAnalyser) return;
            const data = new Uint8Array(micAnalyser.frequencyBinCount);
            micAnalyser.getByteFrequencyData(data);
            const avg = data.reduce((a, b) => a + b, 0) / data.length;
            document.getElementById('micLevel').style.width = Math.min(100, (avg / 128) * 100) + '%';
            micAnimationFrame = requestAnimationFrame(updateMicLevel);
        }

        function toggleMicRecording() { isMicRecording ? stopMicRecording() : startMicRecording(); }

        function startMicRecording() {
            if (!micStream || !micContext) return;
            micChunks = [];

            const recordingDestination = micContext.createMediaStreamDestination();
            outputGainNode.connect(recordingDestination);

            const wasMonitoring = isMonitoring;
            if (!wasMonitoring) outputGainNode.gain.setValueAtTime(1.0, micContext.currentTime);

            mediaRecorder = new MediaRecorder(recordingDestination.stream, { mimeType: MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/mp4' });

            mediaRecorder.ondataavailable = e => { if (e.data.size > 0) micChunks.push(e.data); };
            mediaRecorder.onstop = () => {
                saveMicRecording(new Blob(micChunks, { type: mediaRecorder.mimeType }));
                try { outputGainNode.disconnect(recordingDestination); } catch(e) {}
                if (!wasMonitoring && !isMonitoring) outputGainNode.gain.setValueAtTime(0, micContext.currentTime);
            };

            mediaRecorder.start();
            isMicRecording = true;

            document.getElementById('micDot').classList.remove('ready', 'monitoring');
            document.getElementById('micDot').classList.add('recording');
            document.getElementById('micRecordBtn').innerHTML = '⏹️ Stop';
            document.getElementById('micStatus').textContent = 'Recording...';
            showStatus('Recording...');
        }

        function stopMicRecording() {
            if (mediaRecorder?.state === 'recording') mediaRecorder.stop();
            isMicRecording = false;

            document.getElementById('micDot').classList.remove('recording');
            document.getElementById('micDot').classList.add(isMonitoring ? 'monitoring' : 'ready');
            document.getElementById('micRecordBtn').innerHTML = '⏺️ Record';
            document.getElementById('micStatus').textContent = isMonitoring ? 'Monitoring' : 'Connected';
            showStatus('Recording saved!');
        }

        function disconnectMicrophone() {
            if (isMonitoring) toggleMonitor();
            if (isMicRecording) stopMicRecording();

            if (micStream) { micStream.getTracks().forEach(t => t.stop()); micStream = null; }
            if (micContext) { micContext.close(); micContext = null; }
            if (micAnimationFrame) cancelAnimationFrame(micAnimationFrame);

            micSource = null; micAnalyser = null; micGainNode = null; delayNode = null; feedbackNode = null; wetGainNode = null; dryGainNode = null; outputGainNode = null;

            document.getElementById('micDot').classList.remove('ready', 'recording', 'monitoring');
            document.getElementById('micStatus').textContent = 'Not connected';
            document.getElementById('micLevel').style.width = '0%';
            document.getElementById('micConnectBtn').disabled = false;
            document.getElementById('micRecordBtn').disabled = true;
            document.getElementById('micStopBtn').disabled = true;
            document.getElementById('monitorSwitch').classList.remove('on');
            showStatus('Disconnected');
        }

        function saveMicRecording(blob) {
            const url = URL.createObjectURL(blob);
            const id = Date.now();
            const container = document.getElementById('micRecordings');
            const item = document.createElement('div');
            item.className = 'mic-recording-item';
            item.id = `mic-${id}`;
            item.innerHTML = `<audio controls src="${url}"></audio><button class="delete-btn" onclick="deleteMicRec('${id}','${url}')">🗑️</button>`;
            container.appendChild(item);
        }

        function deleteMicRec(id, url) {
            URL.revokeObjectURL(url);
            document.getElementById(`mic-${id}`)?.remove();
        }

        // UI Generation
        function generateUI() {
            // Piano
            const pianoEl = document.getElementById('piano');
            pianoNotes.forEach((note, i) => {
                const isBlack = note.includes('#');
                const key = document.createElement('button');
                key.className = `piano-key ${isBlack ? 'black' : 'white'}`;
                key.dataset.note = note;
                key.dataset.idx = i;
                key.addEventListener('mousedown', () => playPiano(note, key));
                key.addEventListener('touchstart', e => { e.preventDefault(); playPiano(note, key); }, { passive: false });
                key.addEventListener('mouseup', () => key.classList.remove('active'));
                key.addEventListener('mouseleave', () => key.classList.remove('active'));
                key.addEventListener('touchend', () => key.classList.remove('active'));
                pianoEl.appendChild(key);
            });

            // Drums - with labels
            const drumEl = document.getElementById('drumPads');
            drumPads.forEach((pad, i) => {
                const btn = document.createElement('button');
                btn.className = 'drum-pad';
                btn.style.background = pad.color;
                btn.innerHTML = `${pad.emoji}<span class="pad-label">${pad.name}</span>`;
                btn.dataset.idx = i;
                btn.addEventListener('click', () => playDrum(pad.name.toLowerCase(), btn));
                btn.addEventListener('touchstart', e => { e.preventDefault(); playDrum(pad.name.toLowerCase(), btn); }, { passive: false });
                drumEl.appendChild(btn);
            });

            // Xylophone - with note labels
            const xyloEl = document.getElementById('xylophone');
            xyloNotes.forEach((note, i) => {
                const btn = document.createElement('button');
                btn.className = 'xylo-btn';
                btn.style.background = xyloColors[i];
                btn.innerHTML = `🎵<span class="note-label">${note.replace(/[0-9]/g, '')}</span>`;
                btn.dataset.idx = i;
                btn.addEventListener('click', () => playXylo(note, btn));
                btn.addEventListener('touchstart', e => { e.preventDefault(); playXylo(note, btn); }, { passive: false });
                xyloEl.appendChild(btn);
            });

            // Guitar strings
            const guitarEl = document.getElementById('guitarStrings');
            guitarNotes.forEach((note, i) => {
                const btn = document.createElement('button');
                btn.className = 'string-btn';
                btn.style.background = guitarColors[i];
                btn.innerHTML = `🎸<span class="note-label">${note.replace(/[0-9]/g, '')}</span>`;
                btn.addEventListener('click', () => playGuitar(note, btn));
                btn.addEventListener('touchstart', e => { e.preventDefault(); playGuitar(note, btn); }, { passive: false });
                guitarEl.appendChild(btn);
            });

            // Bells
            const bellsEl = document.getElementById('bellsGrid');
            bellNotes.forEach((note, i) => {
                const btn = document.createElement('button');
                btn.className = 'bell-btn';
                btn.style.background = bellColors[i];
                btn.innerHTML = `🔔<span class="note-label">${note.replace(/[0-9]/g, '')}</span>`;
                btn.addEventListener('click', () => playBells(note, btn));
                btn.addEventListener('touchstart', e => { e.preventDefault(); playBells(note, btn); }, { passive: false });
                bellsEl.appendChild(btn);
            });

            // Bass
            const bassEl = document.getElementById('bassGrid');
            bassNotes.forEach((note, i) => {
                const btn = document.createElement('button');
                btn.className = 'bass-btn';
                btn.style.background = bassColors[i];
                btn.innerHTML = `🎻<span class="note-label">${note.replace(/[0-9]/g, '')}</span>`;
                btn.addEventListener('click', () => playBass(note, btn));
                btn.addEventListener('touchstart', e => { e.preventDefault(); playBass(note, btn); }, { passive: false });
                bassEl.appendChild(btn);
            });

            // Synth Pad
            const synthEl = document.getElementById('synthGrid');
            synthNotes.forEach((note, i) => {
                const btn = document.createElement('button');
                btn.className = 'synth-btn';
                btn.style.background = synthColors[i];
                btn.innerHTML = `🎛️<span class="note-label">${note.replace(/[0-9]/g, '')}</span>`;
                btn.addEventListener('click', () => playSynth(note, btn));
                btn.addEventListener('touchstart', e => { e.preventDefault(); playSynth(note, btn); }, { passive: false });
                synthEl.appendChild(btn);
            });

            // Harp - vertical strings
            const harpEl = document.getElementById('harpStrings');
            harpNotes.forEach((note, i) => {
                const btn = document.createElement('button');
                btn.className = 'harp-btn';
                btn.style.background = `linear-gradient(180deg, ${harpColors[i]} 0%, #8B7355 100%)`;
                btn.style.height = (80 + i * 5) + 'px';
                btn.addEventListener('click', () => playHarp(note, btn));
                btn.addEventListener('touchstart', e => { e.preventDefault(); playHarp(note, btn); }, { passive: false });
                harpEl.appendChild(btn);
            });

            // Kalimba - thumb piano with varying heights
            const kalimbaEl = document.getElementById('kalimbaKeys');
            kalimbaNotes.forEach((note, i) => {
                const btn = document.createElement('button');
                btn.className = 'kalimba-btn';
                btn.style.background = `linear-gradient(180deg, #C0C0C0 0%, ${kalimbaColors[i]} 100%)`;
                btn.style.height = kalimbaHeights[i] + 'px';
                btn.innerHTML = `<span class="inst-note-label">${note.replace(/[0-9]/g, '')}</span>`;
                btn.addEventListener('click', () => playKalimba(note, btn));
                btn.addEventListener('touchstart', e => { e.preventDefault(); playKalimba(note, btn); }, { passive: false });
                kalimbaEl.appendChild(btn);
            });

            // Steel Drums - Caribbean circular pads
            const steelEl = document.getElementById('steelDrums');
            steelDrumNotes.forEach((note, i) => {
                const btn = document.createElement('button');
                btn.className = 'steeldrum-btn';
                btn.style.background = `radial-gradient(circle at 30% 30%, ${steelDrumColors[i]}, ${steelDrumColors[i]}88)`;
                btn.innerHTML = `🎶<span class="inst-note-label">${note.replace(/[0-9]/g, '')}</span>`;
                btn.addEventListener('click', () => playSteelDrum(note, btn));
                btn.addEventListener('touchstart', e => { e.preventDefault(); playSteelDrum(note, btn); }, { passive: false });
                steelEl.appendChild(btn);
            });

            // Organ - church organ pipes
            const organEl = document.getElementById('organKeys');
            organNotes.forEach((note, i) => {
                const btn = document.createElement('button');
                btn.className = 'organ-btn';
                btn.style.background = `linear-gradient(180deg, #D4D4D4 0%, ${organColors[i]} 100%)`;
                btn.style.height = (100 - i * 3) + 'px';
                btn.innerHTML = `<span class="inst-note-label" style="color:#333">${note.replace(/[0-9]/g, '')}</span>`;
                btn.addEventListener('click', () => playOrgan(note, btn));
                btn.addEventListener('touchstart', e => { e.preventDefault(); playOrgan(note, btn); }, { passive: false });
                organEl.appendChild(btn);
            });

            // Marimba - wooden bars
            const marimbaEl = document.getElementById('marimbaKeys');
            marimbaNotes.forEach((note, i) => {
                const btn = document.createElement('button');
                btn.className = 'marimba-btn';
                btn.style.background = `linear-gradient(180deg, ${marimbaColors[i]} 0%, #8B4513 100%)`;
                btn.style.height = marimbaHeights[i] + 'px';
                btn.innerHTML = `🪵<span class="inst-note-label">${note.replace(/[0-9]/g, '')}</span>`;
                btn.addEventListener('click', () => playMarimba(note, btn));
                btn.addEventListener('touchstart', e => { e.preventDefault(); playMarimba(note, btn); }, { passive: false });
                marimbaEl.appendChild(btn);
            });

            // Flute - breathy holes
            const fluteEl = document.getElementById('fluteNotes');
            fluteNotes.forEach((note, i) => {
                const btn = document.createElement('button');
                btn.className = 'flute-btn';
                btn.style.background = `radial-gradient(circle, #E8E8E8 0%, ${fluteColors[i]} 100%)`;
                btn.innerHTML = `🎐<span class="inst-note-label" style="color:#666">${note.replace(/[0-9]/g, '')}</span>`;
                btn.addEventListener('click', () => playFlute(note, btn));
                btn.addEventListener('touchstart', e => { e.preventDefault(); playFlute(note, btn); }, { passive: false });
                fluteEl.appendChild(btn);
            });

            // Music Box - delicate pins
            const chimesEl = document.getElementById('chimesKeys');
            chimesNotes.forEach((note, i) => {
                const btn = document.createElement('button');
                btn.className = 'chimes-btn';
                btn.style.background = `linear-gradient(180deg, ${chimesColors[i]} 0%, #FFB6C1 100%)`;
                btn.innerHTML = `✨`;
                btn.addEventListener('click', () => playChimes(note, btn));
                btn.addEventListener('touchstart', e => { e.preventDefault(); playChimes(note, btn); }, { passive: false });
                chimesEl.appendChild(btn);
            });

            // Trumpet - bold brass
            const trumpetEl = document.getElementById('trumpetNotes');
            trumpetNotes.forEach((note, i) => {
                const btn = document.createElement('button');
                btn.className = 'trumpet-btn';
                btn.style.background = `linear-gradient(135deg, ${trumpetColors[i]} 0%, #B8860B 100%)`;
                btn.innerHTML = `🎺<span class="inst-note-label">${note.replace(/[0-9]/g, '')}</span>`;
                btn.addEventListener('click', () => playTrumpet(note, btn));
                btn.addEventListener('touchstart', e => { e.preventDefault(); playTrumpet(note, btn); }, { passive: false });
                trumpetEl.appendChild(btn);
            });

            // Sound Effects with Freesound API - Initialize category tabs and grid
            renderCategoryTabs();
            renderSoundGrid();
            renderMixer();

            // Tracks
            const trackEl = document.getElementById('trackList');
            tracks.forEach((t, i) => {
                const row = document.createElement('div');
                row.className = 'track-row';
                row.id = `track-${i}`;
                row.innerHTML = `<button class="track-play-btn" onclick="toggleTrack(${i})">▶️</button><span class="track-name">${t.name}</span>`;
                trackEl.appendChild(row);
            });
        }

        // Sound Functions
        function playPiano(note, btn) { initAudio(); synths.piano.triggerAttackRelease(note, '8n'); animateBtn(btn); recordEvent('piano', note); if (state.settings.confetti) spawnConfetti(1); }
        function playXylo(note, btn) { initAudio(); synths.xylophone.triggerAttackRelease(note, '4n'); animateBtn(btn); recordEvent('xylophone', note); if (state.settings.confetti) spawnConfetti(2); }
        function playGuitar(note, btn) { initAudio(); synths.guitar.triggerAttack(note); animateBtn(btn); recordEvent('guitar', note); if (state.settings.confetti) spawnConfetti(2); }
        function playBells(note, btn) { initAudio(); synths.bells.triggerAttackRelease(note, '2n'); animateBtn(btn); recordEvent('bells', note); if (state.settings.confetti) spawnConfetti(3); }
        function playBass(note, btn) { initAudio(); synths.bass.triggerAttackRelease(note, '4n'); animateBtn(btn); recordEvent('bass', note); if (state.settings.confetti) spawnConfetti(1); }
        function playSynth(note, btn) { initAudio(); synths.synthPad.triggerAttackRelease(note, '2n'); animateBtn(btn); recordEvent('synth', note); if (state.settings.confetti) spawnConfetti(2); }

        // New instrument play functions
        function playHarp(note, btn) { initAudio(); synths.harp.triggerAttack(note); animateBtn(btn); recordEvent('harp', note); if (state.settings.confetti) spawnConfetti(2); }
        function playKalimba(note, btn) { initAudio(); synths.kalimba.triggerAttackRelease(note, '2n'); animateBtn(btn); recordEvent('kalimba', note); if (state.settings.confetti) spawnConfetti(2); }
        function playSteelDrum(note, btn) { initAudio(); synths.steelDrum.triggerAttackRelease(note, '4n'); animateBtn(btn); recordEvent('steeldrum', note); if (state.settings.confetti) spawnConfetti(3); }
        function playOrgan(note, btn) { initAudio(); synths.organ.triggerAttackRelease(note, '2n'); animateBtn(btn); recordEvent('organ', note); if (state.settings.confetti) spawnConfetti(1); }
        function playMarimba(note, btn) { initAudio(); synths.marimba.triggerAttackRelease(note, '4n'); animateBtn(btn); recordEvent('marimba', note); if (state.settings.confetti) spawnConfetti(2); }
        function playFlute(note, btn) { initAudio(); synths.flute.triggerAttackRelease(note, '4n'); animateBtn(btn); recordEvent('flute', note); if (state.settings.confetti) spawnConfetti(1); }
        function playChimes(note, btn) { initAudio(); synths.chimes.triggerAttackRelease(note, '2n'); animateBtn(btn); recordEvent('chimes', note); if (state.settings.confetti) spawnConfetti(3); }
        function playTrumpet(note, btn) { initAudio(); synths.trumpet.triggerAttackRelease(note, '4n'); animateBtn(btn); recordEvent('trumpet', note); if (state.settings.confetti) spawnConfetti(2); }

        function playDrum(type, btn) {
            initAudio();
            switch(type) {
                case 'kick': synths.drums.kick.triggerAttackRelease('C2', '8n'); break;
                case 'snare': synths.drums.snare.triggerAttackRelease('8n'); break;
                case 'hi-hat': synths.drums.hihat.triggerAttackRelease('C5', '16n'); break;
                case 'crash': synths.drums.hihat.triggerAttackRelease('C6', '4n'); break;
                case 'tom 1': synths.drums.tom.triggerAttackRelease('G2', '8n'); break;
                case 'tom 2': synths.drums.tom.triggerAttackRelease('D2', '8n'); break;
                case 'tom 3': synths.drums.tom.triggerAttackRelease('A2', '8n'); break;
                case 'clap': synths.drums.clap.triggerAttackRelease('16n'); break;
            }
            animateBtn(btn); recordEvent('drum', type); if (state.settings.confetti) spawnConfetti(3);
        }

        function animateBtn(btn) { if (!btn) return; btn.classList.add('active', 'playing'); setTimeout(() => btn.classList.remove('active', 'playing'), 200); }

        // Keyboard
        document.addEventListener('keydown', e => {
            if (e.repeat) return;
            const key = e.key.toLowerCase();

            if (state.instrument === 'piano') {
                const i = pianoKeys.indexOf(key);
                if (i !== -1) { const el = document.querySelector(`.piano-key[data-idx="${i}"]`); if (el) playPiano(pianoNotes[i], el); }
            } else if (state.instrument === 'xylophone') {
                const keys = ['q','w','e','r','t','y','u','i'];
                const i = keys.indexOf(key);
                if (i !== -1) { const el = document.querySelector(`#xylophone .xylo-btn[data-idx="${i}"]`); if (el) playXylo(xyloNotes[i], el); }
            } else if (state.instrument === 'drums') {
                const i = ['1','2','3','4','5','6','7','8'].indexOf(key);
                if (i !== -1) { const el = document.querySelector(`.drum-pad[data-idx="${i}"]`); if (el) playDrum(drumPads[i].name.toLowerCase(), el); }
            }
        });

        // Instrument Switch
        function switchInstrument(inst, btn) {
            state.instrument = inst;
            document.querySelectorAll('.instrument-chip').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.instrument-area').forEach(a => a.style.display = 'none');
            document.getElementById(`instrument-${inst}`).style.display = 'block';
        }

        // Tracks
        function toggleTrack(idx) {
            initAudio();
            const track = tracks[idx];
            const row = document.getElementById(`track-${idx}`);
            const btn = row.querySelector('.track-play-btn');

            if (state.currentTrack !== null && state.currentTrack !== idx) stopTrack(state.currentTrack);

            if (state.currentTrack === idx) {
                stopTrack(idx);
                state.currentTrack = null;
            } else {
                const loop = createLoop(track.pattern, track.tempo);
                loop.start(0);
                Tone.Transport.start();
                row.classList.add('playing');
                btn.innerHTML = '⏹️';
                btn.classList.add('stop');
                state.currentTrack = idx;
                showStatus(`Playing: ${track.name}`);
            }
        }

        function stopTrack(idx) {
            const row = document.getElementById(`track-${idx}`);
            const btn = row.querySelector('.track-play-btn');
            if (currentLoop) { currentLoop.stop(); Tone.Transport.stop(); }
            row.classList.remove('playing');
            btn.innerHTML = '▶️';
            btn.classList.remove('stop');
        }

        document.getElementById('tempoSlider').addEventListener('input', e => {
            document.getElementById('tempoValue').textContent = `${e.target.value} BPM`;
            Tone.Transport.bpm.value = e.target.value;
        });

        // Recording
        function toggleRecording() {
            const btn = document.getElementById('recBtn');
            const status = document.getElementById('recStatus');

            if (state.isRecording) {
                state.isRecording = false;
                btn.innerHTML = '⏺️ Record';
                status.classList.remove('active');
                status.querySelector('span').textContent = 'Ready to record your music';
                saveRecordingToStorage();
                showStatus('Recording saved!');
            } else {
                state.isRecording = true;
                state.recording = [];
                state.recordingStart = Date.now();
                btn.innerHTML = '⏹️ Stop';
                status.classList.add('active');
                status.querySelector('span').textContent = 'Recording...';
                showStatus('Recording...');
            }
        }

        function recordEvent(type, data) {
            if (!state.isRecording) return;
            state.recording.push({ type, data, time: Date.now() - state.recordingStart });
        }

        function playRecording() {
            if (!state.recording.length) { showStatus('Nothing recorded yet!'); return; }
            showStatus('Playing...');
            state.recording.forEach(ev => {
                setTimeout(() => {
                    switch(ev.type) {
                        case 'piano': synths.piano.triggerAttackRelease(ev.data, '8n'); break;
                        case 'xylophone': synths.xylophone.triggerAttackRelease(ev.data, '4n'); break;
                        case 'drum':
                            switch(ev.data) {
                                case 'kick': synths.drums.kick.triggerAttackRelease('C2', '8n'); break;
                                case 'snare': synths.drums.snare.triggerAttackRelease('8n'); break;
                                default: synths.drums.tom.triggerAttackRelease('G2', '8n');
                            }
                            break;
                        case 'effect': if (effectFns[ev.data]) effectFns[ev.data](); break;
                    }
                }, ev.time);
            });
        }

        function clearRecording() { state.recording = []; showStatus('Recording cleared!'); }

        function saveRecordingToStorage() {
            const recs = JSON.parse(localStorage.getItem('juliaRecs') || '[]');
            recs.push({ date: new Date().toLocaleString(), events: state.recording });
            while (recs.length > 5) recs.shift();
            localStorage.setItem('juliaRecs', JSON.stringify(recs));
            updateSavedRecordings();
        }

        function updateSavedRecordings() {
            const recs = JSON.parse(localStorage.getItem('juliaRecs') || '[]');
            const el = document.getElementById('savedRecordings');
            if (!recs.length) { el.innerHTML = '<p style="color:#999;font-size:0.85rem;">No saved recordings</p>'; return; }
            el.innerHTML = recs.map((r, i) => `<div class="saved-item"><button class="play" onclick="playSaved(${i})">▶️</button><span style="flex:1">Recording ${i + 1}</span><button class="delete" onclick="deleteSaved(${i})">🗑️</button></div>`).join('');
        }

        function playSaved(i) { const recs = JSON.parse(localStorage.getItem('juliaRecs') || '[]'); if (recs[i]) { state.recording = recs[i].events; playRecording(); } }
        function deleteSaved(i) { const recs = JSON.parse(localStorage.getItem('juliaRecs') || '[]'); recs.splice(i, 1); localStorage.setItem('juliaRecs', JSON.stringify(recs)); updateSavedRecordings(); showStatus('Deleted!'); }

        // Settings
        function toggleSettingsPanel() {
            const panel = document.getElementById('settingsPanel');
            const btn = document.getElementById('settingsToggle');
            panel.classList.toggle('show');
            btn.classList.toggle('active');
        }

        function toggleSetting(key, el) {
            state.settings[key] = !state.settings[key];
            el.classList.toggle('on', state.settings[key]);
            if (key === 'bubbles') document.getElementById('bubbles').style.display = state.settings.bubbles ? 'block' : 'none';
            localStorage.setItem('juliaSettings', JSON.stringify(state.settings));
        }

        document.getElementById('volumeSlider').addEventListener('input', e => {
            state.settings.volume = e.target.value;
            Tone.getDestination().volume.value = (state.settings.volume - 80) / 2;
            localStorage.setItem('juliaSettings', JSON.stringify(state.settings));
        });

        function loadSettings() {
            const saved = localStorage.getItem('juliaSettings');
            if (saved) {
                state.settings = { ...state.settings, ...JSON.parse(saved) };
                document.getElementById('volumeSlider').value = state.settings.volume;
                document.getElementById('toggleEffects').classList.toggle('on', state.settings.effects);
                document.getElementById('toggleBubbles').classList.toggle('on', state.settings.bubbles);
                document.getElementById('toggleConfetti').classList.toggle('on', state.settings.confetti);
                document.getElementById('bubbles').style.display = state.settings.bubbles ? 'block' : 'none';
            }
        }

        function toggleMore(btn) {
            const card = btn.closest('.bento-card');
            const more = card.querySelector('.card-more');
            const isOpen = more?.classList.contains('show');
            if (more) { more.classList.toggle('show', !isOpen); btn.classList.toggle('active', !isOpen); }
        }

        // Visualizer
        const canvas = document.getElementById('visualizer');
        const ctx = canvas.getContext('2d');

        function resizeCanvas() {
            canvas.width = canvas.offsetWidth * devicePixelRatio;
            canvas.height = canvas.offsetHeight * devicePixelRatio;
            ctx.scale(devicePixelRatio, devicePixelRatio);
        }

        function drawVisualizer() {
            const w = canvas.offsetWidth, h = canvas.offsetHeight;
            ctx.fillStyle = 'rgba(26,26,46,0.3)';
            ctx.fillRect(0, 0, w, h);

            if (analyser && state.settings.effects) {
                const data = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(data);
                const barW = w / data.length * 2.5;
                let x = 0;
                const grad = ctx.createLinearGradient(0, h, 0, 0);
                grad.addColorStop(0, '#FF6B9D');
                grad.addColorStop(0.5, '#9B59B6');
                grad.addColorStop(1, '#3498DB');
                for (let i = 0; i < data.length; i++) {
                    const barH = (data[i] / 255) * h * 0.8;
                    ctx.fillStyle = grad;
                    ctx.fillRect(x, h - barH, barW - 2, barH);
                    x += barW;
                }
            } else {
                const t = Date.now() / 1000;
                const bars = 30;
                const barW = w / bars;
                for (let i = 0; i < bars; i++) {
                    const barH = Math.sin(t * 2 + i * 0.3) * 20 + 30;
                    ctx.fillStyle = `hsl(${(i / bars) * 360}, 70%, 60%)`;
                    ctx.fillRect(i * barW + 2, h - barH, barW - 4, barH);
                }
            }
            requestAnimationFrame(drawVisualizer);
        }

        // Effects
        function createBubbles() {
            const container = document.getElementById('bubbles');
            const colors = ['#FF6B9D', '#9B59B6', '#3498DB', '#2ECC71', '#F1C40F', '#E67E22'];
            for (let i = 0; i < 15; i++) {
                const b = document.createElement('div');
                b.className = 'bubble';
                b.style.left = Math.random() * 100 + '%';
                b.style.width = b.style.height = (Math.random() * 25 + 10) + 'px';
                b.style.background = colors[Math.floor(Math.random() * colors.length)];
                b.style.animationDuration = (Math.random() * 10 + 10) + 's';
                b.style.animationDelay = (Math.random() * 10) + 's';
                container.appendChild(b);
            }
        }

        function spawnConfetti(n = 5) {
            if (!state.settings.confetti) return;
            const container = document.getElementById('confetti');
            const colors = ['#FF6B9D', '#9B59B6', '#3498DB', '#2ECC71', '#F1C40F', '#E67E22'];
            const shapes = ['■', '●', '▲', '★'];
            for (let i = 0; i < n; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.style.left = Math.random() * 100 + '%';
                c.style.top = '-20px';
                c.style.color = colors[Math.floor(Math.random() * colors.length)];
                c.style.fontSize = (Math.random() * 12 + 8) + 'px';
                c.textContent = shapes[Math.floor(Math.random() * shapes.length)];
                c.style.animationDelay = (Math.random() * 0.5) + 's';
                container.appendChild(c);
                setTimeout(() => c.remove(), 3000);
            }
        }

        function showStatus(msg) {
            const el = document.getElementById('statusToast');
            el.textContent = msg;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 2500);
        }

        // ============================================
        // MAIN TAB SWITCHING
        // ============================================
        function switchMainTab(tabName, btn) {
            // Update tab buttons
            document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');

            // Show/hide music-specific controls
            const musicControls = document.getElementById('musicControls');
            const settingsToggle = document.getElementById('settingsToggle');
            if (tabName === 'music') {
                musicControls.style.display = 'flex';
                settingsToggle.style.display = 'flex';
            } else {
                musicControls.style.display = 'none';
                settingsToggle.style.display = 'none';
            }

            // Resize paint canvas when switching to paint tab
            if (tabName === 'paint') {
                setTimeout(resizePaintCanvas, 100);
            }
        }

        // ============================================
        // PAINT CANVAS
        // ============================================
        let paintCanvas, paintCtx;
        let isDrawing = false;
        let lastX = 0, lastY = 0;
        let currentColor = '#333333';
        let brushSize = 15;
        let isEraser = false;
        let paintHistory = [];
        let historyIndex = -1;

        const paintColors = [
            '#333333', '#FFFFFF', '#E74C3C', '#E67E22', '#F1C40F', '#2ECC71',
            '#1ABC9C', '#3498DB', '#9B59B6', '#FF6B9D', '#8B4513', '#FFD700'
        ];

        function initPaintCanvas() {
            paintCanvas = document.getElementById('paintCanvas');
            paintCtx = paintCanvas.getContext('2d');

            // Generate color buttons
            const colorContainer = document.getElementById('paintColors');
            paintColors.forEach((color, index) => {
                const btn = document.createElement('button');
                btn.className = 'color-btn' + (index === 0 ? ' active' : '');
                btn.style.background = color;
                if (color === '#FFFFFF') {
                    btn.style.border = '2px solid #ddd';
                }
                btn.onclick = () => selectColor(color, btn);
                colorContainer.appendChild(btn);
            });

            // Set up brush size slider
            const brushSlider = document.getElementById('brushSize');
            brushSlider.oninput = () => {
                brushSize = parseInt(brushSlider.value);
                updateBrushPreview();
            };
            updateBrushPreview();

            // Set up canvas
            resizePaintCanvas();

            // Mouse events
            paintCanvas.addEventListener('mousedown', startDrawing);
            paintCanvas.addEventListener('mousemove', draw);
            paintCanvas.addEventListener('mouseup', stopDrawing);
            paintCanvas.addEventListener('mouseout', stopDrawing);

            // Touch events for tablet/mobile
            paintCanvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            paintCanvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            paintCanvas.addEventListener('touchend', stopDrawing);
            paintCanvas.addEventListener('touchcancel', stopDrawing);

            // Prevent scrolling while drawing
            paintCanvas.addEventListener('touchmove', e => e.preventDefault(), { passive: false });

            // Save initial state
            saveToHistory();
        }

        function resizePaintCanvas() {
            if (!paintCanvas) return;
            const wrapper = paintCanvas.parentElement;
            const rect = wrapper.getBoundingClientRect();

            // Save current drawing
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = paintCanvas.width;
            tempCanvas.height = paintCanvas.height;
            tempCanvas.getContext('2d').drawImage(paintCanvas, 0, 0);

            // Resize
            paintCanvas.width = rect.width - 30;
            paintCanvas.height = Math.max(400, window.innerHeight - 280);

            // Restore drawing
            paintCtx.fillStyle = 'white';
            paintCtx.fillRect(0, 0, paintCanvas.width, paintCanvas.height);
            paintCtx.drawImage(tempCanvas, 0, 0);
        }

        function selectColor(color, btn) {
            currentColor = color;
            isEraser = false;
            document.getElementById('eraserBtn').classList.remove('active');
            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updateBrushPreview();
        }

        function toggleEraser() {
            isEraser = !isEraser;
            document.getElementById('eraserBtn').classList.toggle('active', isEraser);
            updateBrushPreview();
        }

        function updateBrushPreview() {
            const preview = document.getElementById('brushPreview');
            const size = Math.min(brushSize, 40);
            preview.style.width = size + 'px';
            preview.style.height = size + 'px';
            preview.style.background = isEraser ? '#f0f0f0' : currentColor;
            preview.style.border = isEraser ? '2px dashed #999' : 'none';
        }

        function getCanvasCoords(e) {
            const rect = paintCanvas.getBoundingClientRect();
            const scaleX = paintCanvas.width / rect.width;
            const scaleY = paintCanvas.height / rect.height;

            if (e.touches) {
                return {
                    x: (e.touches[0].clientX - rect.left) * scaleX,
                    y: (e.touches[0].clientY - rect.top) * scaleY
                };
            }
            return {
                x: (e.clientX - rect.left) * scaleX,
                y: (e.clientY - rect.top) * scaleY
            };
        }

        function startDrawing(e) {
            isDrawing = true;
            const coords = getCanvasCoords(e);
            lastX = coords.x;
            lastY = coords.y;

            // Draw a dot for single clicks/taps
            paintCtx.beginPath();
            paintCtx.arc(lastX, lastY, brushSize / 2, 0, Math.PI * 2);
            paintCtx.fillStyle = isEraser ? 'white' : currentColor;
            paintCtx.fill();
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();

            const coords = getCanvasCoords(e);

            paintCtx.beginPath();
            paintCtx.moveTo(lastX, lastY);
            paintCtx.lineTo(coords.x, coords.y);
            paintCtx.strokeStyle = isEraser ? 'white' : currentColor;
            paintCtx.lineWidth = brushSize;
            paintCtx.lineCap = 'round';
            paintCtx.lineJoin = 'round';
            paintCtx.stroke();

            lastX = coords.x;
            lastY = coords.y;
        }

        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                saveToHistory();
            }
        }

        function handleTouchStart(e) {
            e.preventDefault();
            startDrawing(e);
        }

        function handleTouchMove(e) {
            e.preventDefault();
            draw(e);
        }

        function saveToHistory() {
            // Remove any redo states
            paintHistory = paintHistory.slice(0, historyIndex + 1);
            // Save current state
            paintHistory.push(paintCanvas.toDataURL());
            historyIndex++;
            // Limit history size
            if (paintHistory.length > 50) {
                paintHistory.shift();
                historyIndex--;
            }
        }

        function undoPaint() {
            if (historyIndex > 0) {
                historyIndex--;
                const img = new Image();
                img.onload = () => {
                    paintCtx.fillStyle = 'white';
                    paintCtx.fillRect(0, 0, paintCanvas.width, paintCanvas.height);
                    paintCtx.drawImage(img, 0, 0);
                };
                img.src = paintHistory[historyIndex];
                showStatus('Undo!');
            }
        }

        function clearCanvas() {
            paintCtx.fillStyle = 'white';
            paintCtx.fillRect(0, 0, paintCanvas.width, paintCanvas.height);
            saveToHistory();
            showStatus('Canvas cleared!');
        }

        function saveCanvas() {
            const link = document.createElement('a');
            link.download = 'julia-painting-' + Date.now() + '.png';
            link.href = paintCanvas.toDataURL();
            link.click();
            showStatus('Painting saved!');
        }

        // Init
        window.addEventListener('load', () => {
            generateUI();
            createBubbles();
            loadSettings();
            updateSavedRecordings();
            resizeCanvas();
            drawVisualizer();

            // Initialize new features
            initSequencer();
            renderFavorites();

            // Initialize paint canvas
            initPaintCanvas();
        });

        window.addEventListener('resize', () => {
            resizeCanvas();
            resizePaintCanvas();
        });
    </script>
</body>
</html>
